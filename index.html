<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="ipfans's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="ipfans&#39;s Blog">
<meta property="og:url" content="https://ipfans.github.io/index.html">
<meta property="og:site_name" content="ipfans&#39;s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ipfans&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ipfans.github.io/"/>





  <title>ipfans's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b9862358b198078f40d7e1596b7c5968";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ipfans's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2017/08/install-face-recognition-on-osx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/install-face-recognition-on-osx/" itemprop="url">OSX 下安装 face_recognition</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-02T18:30:00+08:00">
                2017-08-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/install-face-recognition-on-osx/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/08/install-face-recognition-on-osx/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>face_recognition 是一个热门的人脸识别库，常年占据 <a href="https://github.com/trending/python" target="_blank" rel="external">Github Trending Python 子类</a>的 Top10。</p>
<p>在官方文档中，介绍安装 face_recognition 步骤非常简单，只需要执行 <code>pip install face_recognition</code> 就可以了，实际在安装过程中 face_recognition 有一些非 Python 依赖，需要单独安装，本文就对内容进行一个简单介绍，权作记录，方便大家手动安装时提前规避。文章基于 OSX 10.12.6+pyenv+python3.6.2 介绍。</p>
<h2 id="问题在哪里？"><a href="#问题在哪里？" class="headerlink" title="问题在哪里？"></a>问题在哪里？</h2><p>face_recognition 的依赖大部分都比较好安装，只有一个库例外，那就是 <code>dlib</code> 这个依赖。这个依赖需要安装 <code>boost</code> 和 <code>boost-python</code> 两个非 Python 依赖。</p>
<h2 id="安装-Boost-和-boost-python"><a href="#安装-Boost-和-boost-python" class="headerlink" title="安装 Boost 和 boost-python"></a>安装 Boost 和 boost-python</h2><p>这两个库可以通过 <code>Homebrew</code> 快速安装，使用如下命令进行安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">brew install boost</div><div class="line">brew install boost-python --with-python3</div></pre></td></tr></table></figure>
<p>需要注意的是，如果是 Python3 使用，需要额外参数，使用源码编译安装。如果使用 Python2 可以使用 Homebrew 的预编译包。</p>
<h2 id="确认-Python"><a href="#确认-Python" class="headerlink" title="确认 Python"></a>确认 Python</h2><p>dlib 要求 Python 编译时使用 <code>--enable-shared</code> 参数编译，默认情况下，pyenv 未启用该参数，因此编译需要使用下面参数进行 Python 重新编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PYTHON_CONFIGURE_OPTS=&quot;--with-dtrace --enable-shared&quot; pyenv install 3.6.2</div></pre></td></tr></table></figure>
<p>前面一个参数是我一直编译 Python 3.6 使用的参数，方便使用 DTrace 监控 Python 的执行。具体的作用可以参考我<a href="https://ipfans.github.io/2016/09/tracing-python-program-with-dtrace/">之前的文章</a>。</p>
<p>这样还没有完，因为 dlib 的代码问题，对默认 Python3.6 的 library 识别有问题，因此需要将 Python 安装目录下的 lib/libpython3.6m.dylib 复制为 lib/libpython3.6.dylib。一般 pyenv 目录为 <code>~/.pyenv/versions/3.6.2/lib/</code></p>
<h2 id="安装-face-recognition"><a href="#安装-face-recognition" class="headerlink" title="安装 face_recognition"></a>安装 face_recognition</h2><p>接下来就可以使用 pip 正常安装 face_recognition 了，其中 <code>dlib</code> 编译还是需要消耗一些时间的，需要耐心等待。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2017/07/mongodb-optimizing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/mongodb-optimizing/" itemprop="url">一些 MongoDB 的坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-31T18:45:00+08:00">
                2017-07-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/mongodb-optimizing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/07/mongodb-optimizing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于过去的历史原因，我们使用的默认 DB 是 MongoDB 数据库。MongoDB 数据库本身在支持非格式化的数据存储方面有比较大的优势，也不需要额外做很多的 Schema Migration，在我们项目初期，数据存储结构变动频繁时帮助非常大。</p>
<p>但是，随着我们的业务不断增长，我们也遇到了一些问题，这篇文章总结了一些我们在过去的过程中出现的一些问题或者失误，帮助大家在实践过程中进行规避。</p>
<h2 id="集合使用不当问题"><a href="#集合使用不当问题" class="headerlink" title="集合使用不当问题"></a>集合使用不当问题</h2><p>在使用 MongoDB 过程中，我们创建了大量的集合。这种情况在 WiredTriger 引擎下创建大量零散文件。这个在使用过程中暂时未对我们造成实际的业务较大影响，但是从实际使用而言，对整体数据库性能、后续主从复制集群同步，都是有一定影响的。在实际应用过程中应该避免：拥有过多 DB、一个 DB 下有过多 Collection，这样都会导致部分指令的性能大幅度下滑。同时，过多的 DB 也会导致主从同步失败 (listDatabse 超时导致失败，从库退出)。</p>
<h2 id="数据库索引建立"><a href="#数据库索引建立" class="headerlink" title="数据库索引建立"></a>数据库索引建立</h2><p>MongoDB Collection 索引建立功能支持前台创建模式与后台创建模式两种。默认模式为前台创建模式。这种模式下会发生：DB 被锁，主库所有读写被禁止、从库无法访问。从另一方面来说，会导致业务系统的数据库访问受到影响。虽然前台创建模式效率更高，但是如果是线上操作，并且有一定数量级，创建索引时需要添加 <code>{background:true}</code> 让创建索引操作转换为后台操作，尽管时间较长，但是对业务影响较小。同时，该操作也应该在业务量小时进行。</p>
<h2 id="数据库主从切换"><a href="#数据库主从切换" class="headerlink" title="数据库主从切换"></a>数据库主从切换</h2><p>虽然 MongoDB 的 Replica Set 功能可以方便的进行自动主从切换。但是实际使用过程中，我们也会遇到一些需要手工进行主从库切换的情况。比如，进行进行版本升级修复 BUG 或者安全漏洞。但是如果这个时候强行进行 Primary 的重启，则可能会出现未同步至 Secondary 的数据丢失的情况（血泪教训）。这种情况下，重启集群的方式是，优先进行 Secondary 的更新操作，在 Secondary 更新完成后，对 Primary 进行 <a href="https://docs.mongodb.com/manual/reference/method/rs.stepDown/" target="_blank" rel="external">stepDown</a> 操作，等待主节点降级成为 Secondary 节点，之后进行操作。这样的好处是不会丢失数据。但是如果主从数据差异较大时，有可能会造成降级失败，此时可以重复执行 stepDown 直至成功。还有一个值得注意的是，即便 Secondary 可以停机维护，但是仍旧有可能丢数据，这个与 <code>oplog</code> 大小有关，我们放在后面说。</p>
<h2 id="慢查询问题"><a href="#慢查询问题" class="headerlink" title="慢查询问题"></a>慢查询问题</h2><p>慢查询的记录可以通过 Profiling 进行记录，这部分资料比较多，可以通过 <code>db.setProfilingLevel()</code> 进行管理。同时，主动分析也可以通过 <code>explain</code> 进行预分析。这一部分资料比较多，我这里就不再啰嗦了。但是还有一个问题是，部分慢查询操作不会随着客户端断开中断执行，需要通过 <code>db.currentOp()</code> 和 <code>db.killOp()</code> 功能干掉长时间执行、浪费资源的操作。</p>
<h2 id="主从同步延迟问题"><a href="#主从同步延迟问题" class="headerlink" title="主从同步延迟问题"></a>主从同步延迟问题</h2><p>主从同步问题是比较常见的延迟问题了，主要问题都是出在 <code>oplog</code> 上。毕竟主从同步机制都是通过此实现的。<code>oplog</code> 是固定大小的集合，如果满了，就会自动删除老的数据。</p>
<p><img src="https://ws1.sinaimg.cn/large/69e37fdbgy1fi38mlkzgvj20kt0u277g.jpg" alt=""></p>
<p>这里可以看到，此处查询 <code>oplog</code> 操作记录到从库同步，已经执行了 194 毫秒。</p>
<p>上面我们提到，当 Secondary 停机维护时也可能出现问题，就是因为，当 <code>oplog</code> 不足时，那么就有可能会导致数据同步失败。因此一般数据库停机维护操作，也应该放在业务量小的时候进行。不过 <code>oplog</code> 是可以调整的，可以参考 <a href="https://docs.mongodb.com/v3.2/tutorial/change-oplog-size" target="_blank" rel="external">官方文档</a> 进行调整。注意，这需要重启数据库来执行。</p>
<p>主从同步延迟一般出现的情况都是数据出现大量插入和修改的情况。在 Secondary 进行 <code>oplog</code> 重放时，开销会大于 <code>Primary</code> 进行操作的开销。这种情况会产生大量的 <code>oplog</code>（每条修改记录一条，非操作），记录越多，同步速度越慢。同时，某些操作也会大幅度提高单条记录的同步成本，比如 <code>$inc</code>、<code>$push</code> 等等会让同步更慢。如果你对数据库中较大量数据进行 <code>$set</code> 操作，同样也会造成数据延迟。我们的一位工程师就因为这样曾经造成了分钟级别的延迟，教训也是非常惨痛的。这种操作比较频繁时，我们可以通过调整 <code>replWriterThreadCount</code> 参数进行 Secondary 重放线程数量调整。在 MongoDB 中默认为 16，这个可以根据情况进行具体调整。不过该参数为 MongoDB 启动参数，调整该参数会要求重启 MongoDB。另外一个值得注意的是这种操作会加大内存开销，如果内存紧张时也需要注意。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2017/04/grpc-call-timeout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/grpc-call-timeout/" itemprop="url">gRPC 调用超时控制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-06T18:00:00+08:00">
                2017-04-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/grpc-call-timeout/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/04/grpc-call-timeout/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们在进行服务间调用时广泛采用 gRPC 作为主要的调用协议，借助 gRPC 的模块化与语言无关的特性，可以在我们拓展多语言模块之间提供更好的支持。但是我们在使用 gRPC 之中也出现了一些问题，这些问题会做一些记录，希望可以与大家一起沟通与交流。</p>
<p>某日，我们的客服反馈，我们的基础设施操作工具出现了长时间无响应的问题。该问题出现在我们对某些设备进行 OTA 升级时，操作长时间无返回，与之前预期的 10 秒内返回存在较大出入。经过我们的工程师分析，我们发现在 gRPC 处理过程中，我们的操作工具通过 gRPC 调用远程服务端接口时，接口长时间没有返回结果。</p>
<p>我们首先怀疑是 gRPC 调用过程中出现了连接问题。gRPC 过程中可能由于多种原因导致连接断开或者服务器无法连接。在调用 gRPC 方法过程中，我们可以通过 <figure class="highlight plain"><figcaption><span>方式进行快速失败。实际上，这个值默认情况下为 ```true```。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">那么接下来我们就需要从调用从使用角度上寻找问题。我们使用过程中默许服务端在处理某些操作时进行较长时间操作（如长时间操作），但是从客户端角度而言，部分操作正常情况下我们是希望可以在有预定特定环境下达到某些时间仍旧未返回结果可以标记为结果失败。这样就需要通过 gRPC 的机制进行调控。由于目前我们的接口很多情况下调用接口实际为硬件接口，因此，我们采用通过控制 gRPC 客户端接口超时的方法控制。</div><div class="line"></div><div class="line">在 gRPC 中，提供了 MethodConfig 用于控制每个方法的超时时间，这样可以对不同的 RPC 方法设置超时。</div><div class="line"></div><div class="line">下面，我们用 [官方的 gRPC 示例](https://github.com/grpc/grpc-go/tree/master/examples/helloworld) 演示如何进行调用超时控制。</div><div class="line"></div><div class="line">首先，我们在 ```examples/helloworld/greeter_server/main.go``` 中的 ```SayHello``` 中添加一个长时间操作模拟：```time.Sleep(10*time.Second)```。</div><div class="line"></div><div class="line">这时，如果我们需要客户端在 5 秒以内返回结果，应该如何操作呢？</div><div class="line"></div><div class="line">那么我们修改 ```examples/helloworld/greeter_client/main.go``` 中的 ```main```，添加超时处理内容：</div><div class="line"></div><div class="line">```go</div><div class="line">func main() &#123;</div><div class="line">	// Set up method timeout configure.</div><div class="line">	var wg sync.WaitGroup</div><div class="line">	wg.Add(1)</div><div class="line">	ch := make(chan grpc.ServiceConfig)</div><div class="line">	go func() &#123;defer wg.Done()</div><div class="line">		mc := grpc.MethodConfig&#123;</div><div class="line">			WaitForReady: true,</div><div class="line">			Timeout:      5 * time.Second,</div><div class="line">		&#125;</div><div class="line">		m := make(map[string]grpc.MethodConfig)</div><div class="line">		// 格式：/PackageName/ServiceName/MethodName</div><div class="line">		m[&quot;/helloworld.Greeter/SayHello&quot;] = mc</div><div class="line">		sc := grpc.ServiceConfig&#123;Methods: m,&#125;</div><div class="line">		ch &lt;- sc&#125;()</div><div class="line">	// Set up a connection to the server.</div><div class="line">	conn, err := grpc.Dial(address, grpc.WithInsecure())</div><div class="line">	if err != nil &#123;log.Fatalf(&quot;did not connect: %v&quot;, err)</div><div class="line">	&#125;</div><div class="line">	defer conn.Close()</div><div class="line">	c := pb.NewGreeterClient(conn)</div><div class="line"></div><div class="line">	// Contact the server and print out its response.</div><div class="line">	name := defaultName</div><div class="line">	if len(os.Args) &gt; 1 &#123;name = os.Args[1]</div><div class="line">	&#125;</div><div class="line">	log.Printf(&quot;Starting...\n&quot;)   // 明确执行时间</div><div class="line">	r, err := c.SayHello(context.Background(), &amp;pb.HelloRequest&#123;Name: name&#125;)</div><div class="line">	if err != nil &#123;log.Fatalf(&quot;could not greet: %v&quot;, err)</div><div class="line">	&#125;</div><div class="line">	log.Printf(&quot;Greeting: %s&quot;, r.Message)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中根据 MethodConfig 对应 map 结构，可以找到对应方法，对指定方法设置超时时间。最后，执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2017/05/19 15:59:11 Starting call...</div><div class="line">2017/05/19 15:59:17 could not greet: rpc error: code = DeadlineExceeded desc = context deadline exceeded</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2017/02/analyzing-pronto-cycleshare-data-with-python-and-pandas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/analyzing-pronto-cycleshare-data-with-python-and-pandas/" itemprop="url">使用 Python 和 Pandas 分析 Pronto CycleShare 数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-19T18:00:00+08:00">
                2017-02-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/analyzing-pronto-cycleshare-data-with-python-and-pandas/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/02/analyzing-pronto-cycleshare-data-with-python-and-pandas/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这是一篇非常不错的 <a href="https://jakevdp.github.io/blog/2015/10/17/analyzing-pronto-cycleshare-data-with-python-and-pandas/" target="_blank" rel="external">pandas 分析入门文章</a>，在此简单翻译摘录如下。</p>
<hr>
<p>本周，西雅图的自行车共享系统 Pronto CycleShare 一周岁了。 为了庆祝这一点，Pronto 提供了从第一年的数据缓存，并宣布了 <a href="http://www.prontocycleshare.com/datachallenge" target="_blank" rel="external">Pronto Cycle Share 的数据分析挑战</a>。</p>
<p>你可以用很多工具分析这些数据，但我的选择工具是 Python。 在这篇文章中，我想展示如何开始分析这些数据，并使用 PyData 技术栈，即 <a href="http://www.numpy.org/" target="_blank" rel="external">NumPy</a>，<a href="http://pandas.pydata.org/" target="_blank" rel="external">Pandas</a>，<a href="http://matplotlib.org/" target="_blank" rel="external">Matplotlib</a> 和 <a href="http://seaborn.pydata.org/index.html" target="_blank" rel="external">Seaborn</a> 与其他可用的数据源。</p>
<p>这篇文章以 Jupyter Notebook 形式组织，它是一种开放的文档格式。结合了文本、代码、数据和图形，并且通过 Web 浏览器查看。本文中的内容可以下载 <a href="http://jakevdp.github.io/downloads/notebooks/ProntoData.ipynb" target="_blank" rel="external">对应的 Notebook 文件</a>，并通过 Jupyter 打开。</p>
<h2 id="下载-Pronto-的数据"><a href="#下载-Pronto-的数据" class="headerlink" title="下载 Pronto 的数据"></a>下载 Pronto 的数据</h2><p>我们可以从 <a href="http://www.prontocycleshare.com/datachallenge" target="_blank" rel="external">Pronto 官网</a> 下载对应的 <a href="https://s3.amazonaws.com/pronto-data/open_data_year_one.zip" target="_blank" rel="external">数据文件</a>。总下载大约 70MB，解压缩的文件大约 900MB。</p>
<p>接下来我们需要导入一些 Python 包：</p>
<p>In [2]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">%matplotlib inline</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns; sns.set()</div></pre></td></tr></table></figure>
<p>现在我们使用 Pandas 加载所有的行程记录：</p>
<p>In [3]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">trips = pd.read_csv(<span class="string">'2015_trip_data.csv'</span>,</div><div class="line">                    parse_dates=[<span class="string">'starttime'</span>, <span class="string">'stoptime'</span>],</div><div class="line">                    infer_datetime_format=<span class="keyword">True</span>)</div><div class="line">trips.head()</div></pre></td></tr></table></figure>
<p>Out[3]:</p>
<table border="1" class="dataframe"><br>  <thead><br>    <tr style="text-align: right;"><br>      <th></th><br>      <th>trip_id</th><br>      <th>starttime</th><br>      <th>stoptime</th><br>      <th>bikeid</th><br>      <th>tripduration</th><br>      <th>from_station_name</th><br>      <th>to_station_name</th><br>      <th>from_station_id</th><br>      <th>to_station_id</th><br>      <th>usertype</th><br>      <th>gender</th><br>      <th>birthyear</th><br>    </tr><br>  </thead><br>  <tbody><br>    <tr><br>      <th>0</th><br>      <td>431</td><br>      <td>2014-10-13 10:31:00</td><br>      <td>2014-10-13 10:48:00</td><br>      <td>SEA00298</td><br>      <td>985.935</td><br>      <td>2nd Ave &amp; Spring St</td><br>      <td>Occidental Park / Occidental Ave S &amp; S Washing…</td><br>      <td>CBD-06</td><br>      <td>PS-04</td><br>      <td>Annual Member</td><br>      <td>Male</td><br>      <td>1960</td><br>    </tr><br>    <tr><br>      <th>1</th><br>      <td>432</td><br>      <td>2014-10-13 10:32:00</td><br>      <td>2014-10-13 10:48:00</td><br>      <td>SEA00195</td><br>      <td>926.375</td><br>      <td>2nd Ave &amp; Spring St</td><br>      <td>Occidental Park / Occidental Ave S &amp; S Washing…</td><br>      <td>CBD-06</td><br>      <td>PS-04</td><br>      <td>Annual Member</td><br>      <td>Male</td><br>      <td>1970</td><br>    </tr><br>    <tr><br>      <th>2</th><br>      <td>433</td><br>      <td>2014-10-13 10:33:00</td><br>      <td>2014-10-13 10:48:00</td><br>      <td>SEA00486</td><br>      <td>883.831</td><br>      <td>2nd Ave &amp; Spring St</td><br>      <td>Occidental Park / Occidental Ave S &amp; S Washing…</td><br>      <td>CBD-06</td><br>      <td>PS-04</td><br>      <td>Annual Member</td><br>      <td>Female</td><br>      <td>1988</td><br>    </tr><br>    <tr><br>      <th>3</th><br>      <td>434</td><br>      <td>2014-10-13 10:34:00</td><br>      <td>2014-10-13 10:48:00</td><br>      <td>SEA00333</td><br>      <td>865.937</td><br>      <td>2nd Ave &amp; Spring St</td><br>      <td>Occidental Park / Occidental Ave S &amp; S Washing…</td><br>      <td>CBD-06</td><br>      <td>PS-04</td><br>      <td>Annual Member</td><br>      <td>Female</td><br>      <td>1977</td><br>    </tr><br>    <tr><br>      <th>4</th><br>      <td>435</td><br>      <td>2014-10-13 10:34:00</td><br>      <td>2014-10-13 10:49:00</td><br>      <td>SEA00202</td><br>      <td>923.923</td><br>      <td>2nd Ave &amp; Spring St</td><br>      <td>Occidental Park / Occidental Ave S &amp; S Washing…</td><br>      <td>CBD-06</td><br>      <td>PS-04</td><br>      <td>Annual Member</td><br>      <td>Male</td><br>      <td>1971</td><br>    </tr><br>  </tbody><br></table>

<p>这个行程数据集的每一行是由一个人单独骑行，共包含超过 140,000 条数据。</p>
<h2 id="探索时间与行程的关系"><a href="#探索时间与行程的关系" class="headerlink" title="探索时间与行程的关系"></a>探索时间与行程的关系</h2><p>让我们先看看一年中每日行程次数的趋势。</p>
<p>In [4]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Find the start date</span></div><div class="line">ind = pd.DatetimeIndex(trips.starttime)</div><div class="line">trips[<span class="string">'date'</span>] = ind.date.astype(<span class="string">'datetime64'</span>)</div><div class="line">trips[<span class="string">'hour'</span>] = ind.hour</div></pre></td></tr></table></figure>
<p>In [5]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Count trips by date</span></div><div class="line">by_date = trips.pivot_table(<span class="string">'trip_id'</span>, aggfunc=<span class="string">'count'</span>,</div><div class="line">                            index=<span class="string">'date'</span>,</div><div class="line">                            columns=<span class="string">'usertype'</span>, )</div></pre></td></tr></table></figure>
<p>In [6]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fig, ax = plt.subplots(<span class="number">2</span>, figsize=(<span class="number">16</span>, <span class="number">8</span>))</div><div class="line">fig.subplots_adjust(hspace=<span class="number">0.4</span>)</div><div class="line">by_date.iloc[:, <span class="number">0</span>].plot(ax=ax[<span class="number">0</span>], title=<span class="string">'Annual Members'</span>);</div><div class="line">by_date.iloc[:, <span class="number">1</span>].plot(ax=ax[<span class="number">1</span>], title=<span class="string">'Day-Pass Users'</span>);</div></pre></td></tr></table></figure>
<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvpy4sgpyj20pu0ebjuf" alt=""></p>
<p>此图显示每日趋势，以年费用户（上图）和临时用户（下图）分隔。 根据图标，我们可以获得几个结论：</p>
<ul>
<li>4 月份短期使用的临时用户大幅增加可能是由于 <a href="http://www.planetizen.com/node/75958/seattle-sets-bikeshare-record-apa-town" target="_blank" rel="external">美国规划协会全国会议</a> 在西雅图市中心举行。 其他一个比较接近的时间是 7 月 4 日周末。</li>
<li>临时用户呈现了一个与季节相关联的稳定的衰退趋势; 年费用户的使用没有随着秋天的来临而显着减少。</li>
<li>年费用户和临时用户似乎都显示出明显的每周趋势。</li>
</ul>
<p>现在放大每周趋势，看一下所有的骑乘都是按照星期几分部的。由于 2015 年 1 月份左右模式的变化，我们按照年份和星期几进行拆分：</p>
<p>In [7]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">by_weekday = by_date.groupby([by_date.index.year,</div><div class="line">                              by_date.index.dayofweek]).mean()</div><div class="line">by_weekday.columns.name = <span class="keyword">None</span>  <span class="comment"># remove label for plot</span></div><div class="line"></div><div class="line">fig, ax = plt.subplots(<span class="number">1</span>, <span class="number">2</span>, figsize=(<span class="number">16</span>, <span class="number">6</span>), sharey=<span class="keyword">True</span>)</div><div class="line">by_weekday.loc[<span class="number">2014</span>].plot(title=<span class="string">'Average Use by Day of Week (2014)'</span>, ax=ax[<span class="number">0</span>]);</div><div class="line">by_weekday.loc[<span class="number">2015</span>].plot(title=<span class="string">'Average Use by Day of Week (2015)'</span>, ax=ax[<span class="number">1</span>]);</div><div class="line"><span class="keyword">for</span> axi <span class="keyword">in</span> ax:</div><div class="line">    axi.set_xticklabels([<span class="string">'Mon'</span>, <span class="string">'Tues'</span>, <span class="string">'Wed'</span>, <span class="string">'Thurs'</span>, <span class="string">'Fri'</span>, <span class="string">'Sat'</span>, <span class="string">'Sun'</span>])</div></pre></td></tr></table></figure>
<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvtq0o8jaj20q20aimxv" alt=""></p>
<p>我们看到了一个互补的模式：年费用户倾向于工作日使用他们的自行车（即作为通勤的一部分），而临时用户倾向于在周末使用他们的自行车。这种模式甚至在 2015 年年初都没有特别的体现出来，尤其是年费用户：似乎在头几个月，用户还没有使用 Pronto 的通勤习惯。</p>
<p>查看平日和周末的平均每小时骑行也很有趣。这需要一些操作：</p>
<p>In [8]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># count trips by date and by hour</span></div><div class="line">by_hour = trips.pivot_table(<span class="string">'trip_id'</span>, aggfunc=<span class="string">'count'</span>,</div><div class="line">                            index=[<span class="string">'date'</span>, <span class="string">'hour'</span>],</div><div class="line">                            columns=<span class="string">'usertype'</span>).fillna(<span class="number">0</span>).reset_index(<span class="string">'hour'</span>)</div><div class="line"></div><div class="line"><span class="comment"># average these counts by weekend</span></div><div class="line">by_hour[<span class="string">'weekend'</span>] = (by_hour.index.dayofweek&gt;= <span class="number">5</span>)</div><div class="line">by_hour = by_hour.groupby([<span class="string">'weekend'</span>, <span class="string">'hour'</span>]).mean()</div><div class="line">by_hour.index.set_levels([[<span class="string">'weekday'</span>, <span class="string">'weekend'</span>],</div><div class="line">                          [<span class="string">"&#123;0&#125;:00"</span>.format(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">24</span>)]],</div><div class="line">                         inplace=<span class="keyword">True</span>);</div><div class="line">by_hour.columns.name = <span class="keyword">None</span></div></pre></td></tr></table></figure>
<p>现在我们可以绘制结果来查看每小时的趋势：</p>
<p>In [9]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fig, ax = plt.subplots(<span class="number">1</span>, <span class="number">2</span>, figsize=(<span class="number">16</span>, <span class="number">6</span>), sharey=<span class="keyword">True</span>)</div><div class="line">by_hour.loc[<span class="string">'weekday'</span>].plot(title=<span class="string">'Average Hourly Use (Mon-Fri)'</span>, ax=ax[<span class="number">0</span>])</div><div class="line">by_hour.loc[<span class="string">'weekend'</span>].plot(title=<span class="string">'Average Hourly Use (Sat-Sun)'</span>, ax=ax[<span class="number">1</span>])</div><div class="line">ax[<span class="number">0</span>].set_ylabel(<span class="string">'Average Trips per Hour'</span>);</div></pre></td></tr></table></figure>
<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvtx6xmpqj20q30axgmm" alt=""></p>
<p>我们看到一个 “通勤” 模式和一个 “娱乐” 模式之间的明显区别:“通勤” 模式在早上和晚上急剧上升，而 “娱乐” 模式在下午的时候有一个宽峰。 有趣的是，年费会员在周末的行为似乎与临时用户在周末的行为几乎相同。</p>
<h2 id="旅行时间"><a href="#旅行时间" class="headerlink" title="旅行时间"></a>旅行时间</h2><p>接下来，我们来看看旅行的持续时间。 Pronto 免费骑行最长可达 30 分钟; 任何长于此的单次使用，在前半个小时都会产生几美元的使用费，此后每小时大约需要十美元。</p>
<p>让我们看看年费会员和临时使用者的旅行持续时间的分布：</p>
<p>In [10]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">trips[<span class="string">'minutes'</span>] = trips.tripduration / <span class="number">60</span></div><div class="line">trips.groupby(<span class="string">'usertype'</span>)[<span class="string">'minutes'</span>].hist(bins=np.arange(<span class="number">61</span>), alpha=<span class="number">0.5</span>, normed=<span class="keyword">True</span>);</div><div class="line">plt.xlabel(<span class="string">'Duration (minutes)'</span>)</div><div class="line">plt.ylabel(<span class="string">'relative frequency'</span>)</div><div class="line">plt.title(<span class="string">'Trip Durations'</span>)</div><div class="line">plt.text(<span class="number">34</span>, <span class="number">0.09</span>,<span class="string">"Free Trips\n\nAdditional Fee"</span>, ha=<span class="string">'right'</span>,</div><div class="line">         size=<span class="number">18</span>, rotation=<span class="number">90</span>, alpha=<span class="number">0.5</span>, color=<span class="string">'red'</span>)</div><div class="line">plt.legend([<span class="string">'Annual Members'</span>, <span class="string">'Short-term Pass'</span>])</div><div class="line"></div><div class="line">plt.axvline(<span class="number">30</span>, linestyle=<span class="string">'--'</span>, color=<span class="string">'red'</span>, alpha=<span class="number">0.3</span>);</div></pre></td></tr></table></figure>
<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvu4jj5p0j20e20a5aab" alt=""></p>
<p>在这里，我添加了一个红色的虚线，分开免费骑乘（左）和付费骑乘（右）。看来，年费用户对系统规则更加了解：只有行程分布的一小部分超过 30 分钟。另一方面，大约四分之一的临时用户时间超过半小时限制，并收取额外费用。 我的预期是，这些临时用户不能很好理解这种定价结构，并且可能会因为不开心的体验不再使用。</p>
<h2 id="估计行程距离"><a href="#估计行程距离" class="headerlink" title="估计行程距离"></a>估计行程距离</h2><p>看看旅行的距离也十分有趣。Pronto 发布的数据中不包括行车的距离，因此我们需要通过其他来源来确定。让我们从加载行车数据开始 - 因为一些行程在 Pronto 的服务点之间开始和结束，我们将其添加为一个 “车站”：</p>
<p>In [11]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">stations = pd.read_csv(<span class="string">'2015_station_data.csv'</span>)</div><div class="line">pronto_shop = dict(id=<span class="number">54</span>, name=<span class="string">"Pronto shop"</span>,</div><div class="line">                   terminal=<span class="string">"Pronto shop"</span>,</div><div class="line">                   lat=<span class="number">47.6173156</span>, long=<span class="number">-122.3414776</span>,</div><div class="line">                   dockcount=<span class="number">100</span>, online=<span class="string">'10/13/2014'</span>)</div><div class="line">stations = stations.append(pronto_shop, ignore_index=<span class="keyword">True</span>)</div></pre></td></tr></table></figure>
<p>现在我们需要找到两对纬度 / 经度坐标之间的骑车距离。幸运的是，Google 地图有一个距离 API，我们可以免费使用。</p>
<p>从文档中知道，我们每天免费使用的限制为每天最多 2500 个距离，每 10 秒最多 100 个距离。现在有 55 个站，我们有（55 * 54/2） = 1485 个非零距离，所以我们可以在几天内免费查询所有车站之间的距离。</p>
<p>为此，我们一次查询一行，在查询之间等待 10 + 秒（注意：我们可能还会使用 googlemaps Python 包 ，但使用它需要获取 API 密钥）。</p>
<p>In [12]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_distances</span><span class="params">(stations=stations)</span>:</span></div><div class="line">    <span class="string">"""Query the Google API for bicycling distances"""</span></div><div class="line">    latlon_list = [<span class="string">'&#123;0&#125;,&#123;1&#125;'</span>.format(lat, long)</div><div class="line">                   <span class="keyword">for</span> (lat, long) <span class="keyword">in</span> zip(stations.lat, stations.long)]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_url</span><span class="params">(i)</span>:</span></div><div class="line">        URL = (<span class="string">'https://maps.googleapis.com/maps/api/distancematrix/json?'</span></div><div class="line">               <span class="string">'origins=&#123;origins&#125;&amp;destinations=&#123;destinations&#125;&amp;mode=bicycling'</span>)</div><div class="line">        <span class="keyword">return</span> URL.format(origins=latlon_list[i],</div><div class="line">                          destinations=<span class="string">'|'</span>.join(latlon_list[i + <span class="number">1</span>:]))</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(latlon_list) - <span class="number">1</span>):</div><div class="line">        url = create_url(i)</div><div class="line">        filename = <span class="string">"distances_&#123;0&#125;.json"</span>.format(stations.terminal.iloc[i])</div><div class="line">        print(i, filename)</div><div class="line">        !curl <span class="string">"&#123;url&#125;"</span> -o &#123;filename&#125;</div><div class="line">        sleep(<span class="number">11</span>) <span class="comment"># only one query per 10 seconds!</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_distance_matrix</span><span class="params">(stations=stations)</span>:</span></div><div class="line">    <span class="string">"""Build a matrix from the Google API results"""</span></div><div class="line">    dist = np.zeros((len(stations), len(stations)), dtype=float)</div><div class="line">    <span class="keyword">for</span> i, term <span class="keyword">in</span> enumerate(stations.terminal[:<span class="number">-1</span>]):</div><div class="line">        filename = <span class="string">'queried_distances/distances_&#123;0&#125;.json'</span>.format(term)</div><div class="line">        row = json.load(open(filename))</div><div class="line">        dist[i, i + <span class="number">1</span>:] = [el[<span class="string">'distance'</span>][<span class="string">'value'</span>] <span class="keyword">for</span> el <span class="keyword">in</span> row[<span class="string">'rows'</span>][<span class="number">0</span>][<span class="string">'elements'</span>]]</div><div class="line">    dist += dist.T</div><div class="line">    distances = pd.DataFrame(dist, index=stations.terminal,</div><div class="line">                             columns=stations.terminal)</div><div class="line">    distances.to_csv(<span class="string">'station_distances.csv'</span>)</div><div class="line">    <span class="keyword">return</span> distances</div><div class="line"></div><div class="line"><span class="comment"># only call this the first time</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'station_distances.csv'</span>):</div><div class="line">    <span class="comment"># Note: you can call this function at most ~twice per day!</span></div><div class="line">    query_distances()</div><div class="line"></div><div class="line">    <span class="comment"># Move all the queried files into a directory</span></div><div class="line">    <span class="comment"># so we don't accidentally overwrite them</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'queried_distances'</span>):</div><div class="line">        os.makedirs(<span class="string">'queried_distances'</span>)</div><div class="line">    !mv distances_*.json queried_distances</div><div class="line"></div><div class="line">    <span class="comment"># Build distance matrix and save to CSV</span></div><div class="line">    distances = build_distance_matrix()</div></pre></td></tr></table></figure>
<p>这里是第一个 5x5 距离矩阵：</p>
<p>In [13]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">distances = pd.read_csv(<span class="string">'station_distances.csv'</span>, index_col=<span class="string">'terminal'</span>)</div><div class="line">distances.iloc[:<span class="number">5</span>, :<span class="number">5</span>]</div></pre></td></tr></table></figure>
<p>Out[13]:</p>
<table border="1" class="dataframe"><br>  <thead><br>    <tr style="text-align: right;"><br>      <th></th><br>      <th>BT-01</th><br>      <th>BT-03</th><br>      <th>BT-04</th><br>      <th>BT-05</th><br>      <th>CBD-13</th><br>    </tr><br>    <tr><br>      <th>terminal</th><br>      <th></th><br>      <th></th><br>      <th></th><br>      <th></th><br>      <th></th><br>    </tr><br>  </thead><br>  <tbody><br>    <tr><br>      <th>BT-01</th><br>      <td>0</td><br>      <td>422</td><br>      <td>1067</td><br>      <td>867</td><br>      <td>1342</td><br>    </tr><br>    <tr><br>      <th>BT-03</th><br>      <td>422</td><br>      <td>0</td><br>      <td>838</td><br>      <td>445</td><br>      <td>920</td><br>    </tr><br>    <tr><br>      <th>BT-04</th><br>      <td>1067</td><br>      <td>838</td><br>      <td>0</td><br>      <td>1094</td><br>      <td>1121</td><br>    </tr><br>    <tr><br>      <th>BT-05</th><br>      <td>867</td><br>      <td>445</td><br>      <td>1094</td><br>      <td>0</td><br>      <td>475</td><br>    </tr><br>    <tr><br>      <th>CBD-13</th><br>      <td>1342</td><br>      <td>920</td><br>      <td>1121</td><br>      <td>475</td><br>      <td>0</td><br>    </tr><br>  </tbody><br></table>

<p>让我们将这些距离转换为英里，并将它们加入我们的行程数据：</p>
<p>In [14]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">stacked = distances.stack() / <span class="number">1609.34</span>  <span class="comment"># convert meters to miles</span></div><div class="line">stacked.name = <span class="string">'distance'</span></div><div class="line">trips = trips.join(stacked, on=[<span class="string">'from_station_id'</span>,<span class="string">'to_station_id'</span>])</div></pre></td></tr></table></figure>
<p>现在我们可以绘制行程距离的分布：</p>
<p>In [15]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">fig, ax = plt.subplots(figsize=(<span class="number">12</span>, <span class="number">4</span>))</div><div class="line">trips.groupby(<span class="string">'usertype'</span>)[<span class="string">'distance'</span>].hist(bins=np.linspace(<span class="number">0</span>, <span class="number">6.99</span>, <span class="number">50</span>),</div><div class="line">                                           alpha=<span class="number">0.5</span>, ax=ax);</div><div class="line">plt.xlabel(<span class="string">'Distance between start &amp; end (miles)'</span>)</div><div class="line">plt.ylabel(<span class="string">'relative frequency'</span>)</div><div class="line">plt.title(<span class="string">'Minimum Distance of Trip'</span>)</div><div class="line">plt.legend([<span class="string">'Annual Members'</span>, <span class="string">'Short-term Pass'</span>]);</div></pre></td></tr></table></figure>
<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvuk9mwpzj20ke07tjrm" alt=""></p>
<p>请记住，这显示站点之间的最短可能距离，是每次行程上实际距离的下限。许多旅行（特别是临时用户）在几个街区内开始和结束。除此之外，旅行高峰一般在大约 1 英里左右，也有一些用户将他们的旅行距离扩展到四英里或更长的距离。</p>
<h2 id="骑手速度"><a href="#骑手速度" class="headerlink" title="骑手速度"></a>骑手速度</h2><p>给定这些距离，我们还可以计算估计骑行速度的下限。 让我们这样做，然后看看年费用户和临时用户的速度分布：</p>
<p>In [16]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">trips[<span class="string">'speed'</span>] = trips.distance * <span class="number">60</span> / trips.minutes</div><div class="line">trips.groupby(<span class="string">'usertype'</span>)[<span class="string">'speed'</span>].hist(bins=np.linspace(<span class="number">0</span>, <span class="number">15</span>, <span class="number">50</span>), alpha=<span class="number">0.5</span>, normed=<span class="keyword">True</span>);</div><div class="line">plt.xlabel(<span class="string">'lower bound riding speed (MPH)'</span>)</div><div class="line">plt.ylabel(<span class="string">'relative frequency'</span>)</div><div class="line">plt.title(<span class="string">'Rider Speed Lower Bound (MPH)'</span>)</div><div class="line">plt.legend([<span class="string">'Annual Members'</span>, <span class="string">'Short-term Pass'</span>]);</div></pre></td></tr></table></figure>
<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvuq6y9e5j20dw0a5dg1" alt=""></p>
<p>有趣的是，分布是完全不同的，年费用户的速度平均值更高一些。你可能会想到这里的结论，年费用户的速度比临时用户更高，但数据本身不足以支持这一结论。如果年费用户倾向于通过最直接的路线从点 A 去往点 B，那么这些数据也可以被解释，而临时用户倾向于绕行并间接到达他们的目的地。我怀疑现实是这两种效应的混合。</p>
<p>还要看看距离和速度之间的关系：</p>
<p>In [17]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">g = sns.FacetGrid(trips, col=<span class="string">"usertype"</span>, hue=<span class="string">'usertype'</span>, size=<span class="number">6</span>)</div><div class="line">g.map(plt.scatter,<span class="string">"distance"</span>,<span class="string">"speed"</span>, s=<span class="number">4</span>, alpha=<span class="number">0.2</span>)</div><div class="line"></div><div class="line"><span class="comment"># Add lines and labels</span></div><div class="line">x = np.linspace(<span class="number">0</span>, <span class="number">10</span>)</div><div class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].set_ylabel(<span class="string">'Lower Bound Speed'</span>)</div><div class="line"><span class="keyword">for</span> ax <span class="keyword">in</span> g.axes.flat:</div><div class="line">    ax.set_xlabel(<span class="string">'Lower Bound Distance'</span>)</div><div class="line">    ax.plot(x, <span class="number">2</span> * x,<span class="string">'--r'</span>, alpha=<span class="number">0.3</span>)</div><div class="line">    ax.text(<span class="number">9.8</span>, <span class="number">16.5</span>,<span class="string">"Free Trips\n\nAdditional Fee"</span>, ha=<span class="string">'right'</span>,</div><div class="line">            size=<span class="number">18</span>, rotation=<span class="number">39</span>, alpha=<span class="number">0.5</span>, color=<span class="string">'red'</span>)</div><div class="line">    ax.axis([<span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">25</span>])</div></pre></td></tr></table></figure>
<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvut21qj5j20no0butca" alt=""></p>
<p>总的来说，我们看到较长的路途速度更快 - 虽然这受到与上述相同的下限影响。如上所述，作为参考，我绘制了需要的红线用于区分额外费用（低于红线）和免费费用（红线以上）。我们再次看到，年度会员对于不超过半小时的限制比每天通过用户更加精明 - 点的分布的指向了用户注意了他们使用的时间，以避免额外的费用。</p>
<h2 id="海拔高度"><a href="#海拔高度" class="headerlink" title="海拔高度"></a>海拔高度</h2><p>在西雅图自行车分享服务的可行性的一个焦点是，西雅图是一个丘陵城市。在服务发布之前，一些分析师预测，西雅图会有源源不断的自行车上坡下坡，所以并不适合分享单车系统的落地。</p>
<p>数据版本中不包含海拔高度数据，但我们可以转到 Google Maps API 获取我们需要的数据; 请参阅 <a href="https://developers.google.com/maps/documentation/elevation/intro" target="_blank" rel="external">此网站</a> 了解海拔 API 的描述。</p>
<p>在这种情况下，自由使用限制为每天 2500 个请求，每次请求最多包含 512 个海拔高度。 由于我们只需要 55 个海拔高度，我们可以在单个查询中执行：</p>
<p>In [18]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_station_elevations</span><span class="params">(stations)</span>:</span></div><div class="line">    <span class="string">"""Get station elevations via Google Maps API"""</span></div><div class="line">    URL = <span class="string">"https://maps.googleapis.com/maps/api/elevation/json?locations="</span></div><div class="line">    locs = <span class="string">'|'</span>.join([<span class="string">'&#123;0&#125;,&#123;1&#125;'</span>.format(lat, long)</div><div class="line">                     <span class="keyword">for</span> (lat, long) <span class="keyword">in</span> zip(stations.lat, stations.long)])</div><div class="line">    URL += locs</div><div class="line">    !curl <span class="string">"&#123;URL&#125;"</span> -o elevations.json</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_station_elevations</span><span class="params">()</span>:</span><span class="string">"""Convert Elevations JSON output to CSV"""</span></div><div class="line">    <span class="keyword">import</span> json</div><div class="line">    D = json.load(open(<span class="string">'elevations.json'</span>))</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unnest</span><span class="params">(D)</span>:</span></div><div class="line">        loc = D.pop(<span class="string">'location'</span>)</div><div class="line">        loc.update(D)</div><div class="line">        <span class="keyword">return</span> loc</div><div class="line">    elevs = pd.DataFrame([unnest(item) <span class="keyword">for</span> item <span class="keyword">in</span> D[<span class="string">'results'</span>]])</div><div class="line">    elevs.to_csv(<span class="string">'station_elevations.csv'</span>)</div><div class="line">    <span class="keyword">return</span> elevs</div><div class="line"></div><div class="line"><span class="comment"># only run this the first time:</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'station_elevations.csv'</span>):</div><div class="line">    get_station_elevations(stations)</div><div class="line">    process_station_elevations()</div></pre></td></tr></table></figure>
<p>现在让我们读入海拔高度数据：</p>
<p>In [19]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">elevs = pd.read_csv(<span class="string">'station_elevations.csv'</span>, index_col=<span class="number">0</span>)</div><div class="line">elevs.head()</div></pre></td></tr></table></figure>
<p>Out[19]:</p>
<table border="1" class="dataframe"><br>  <thead><br>    <tr style="text-align: right;"><br>      <th></th><br>      <th>elevation</th><br>      <th>lat</th><br>      <th>lng</th><br>      <th>resolution</th><br>    </tr><br>  </thead><br>  <tbody><br>    <tr><br>      <th>0</th><br>      <td>37.351780</td><br>      <td>47.618418</td><br>      <td>-122.350964</td><br>      <td>76.351616</td><br>    </tr><br>    <tr><br>      <th>1</th><br>      <td>33.815830</td><br>      <td>47.615829</td><br>      <td>-122.348564</td><br>      <td>76.351616</td><br>    </tr><br>    <tr><br>      <th>2</th><br>      <td>34.274055</td><br>      <td>47.616094</td><br>      <td>-122.341102</td><br>      <td>76.351616</td><br>    </tr><br>    <tr><br>      <th>3</th><br>      <td>44.283257</td><br>      <td>47.613110</td><br>      <td>-122.344208</td><br>      <td>76.351616</td><br>    </tr><br>    <tr><br>      <th>4</th><br>      <td>42.460381</td><br>      <td>47.610185</td><br>      <td>-122.339641</td><br>      <td>76.351616</td><br>    </tr><br>  </tbody><br></table>

<p>为了验证结果，我们需要仔细检查纬度和经度是否匹配：</p>
<p>In [20]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># double check that locations match</span></div><div class="line">print(np.allclose(stations.long, elevs.lng))</div><div class="line">print(np.allclose(stations.lat, elevs.lat))</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">True</div><div class="line">True</div></pre></td></tr></table></figure>
<p>现在我们可以将海拔数据与行程数据整合：</p>
<p>In [21]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">stations[<span class="string">'elevation'</span>] = elevs[<span class="string">'elevation'</span>]</div><div class="line">elevs.index = stations[<span class="string">'terminal'</span>]</div><div class="line"></div><div class="line">trips[<span class="string">'elevation_start'</span>] = trips.join(elevs, on=<span class="string">'from_station_id'</span>)[<span class="string">'elevation'</span>]</div><div class="line">trips[<span class="string">'elevation_end'</span>] = trips.join(elevs, on=<span class="string">'to_station_id'</span>)[<span class="string">'elevation'</span>]</div><div class="line">trips[<span class="string">'elevation_gain'</span>] = trips[<span class="string">'elevation_end'</span>] - trips[<span class="string">'elevation_start'</span>]</div></pre></td></tr></table></figure>
<p>让我们来看看海拔数据和会员类型的分布关系：</p>
<p>In [22]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">g = sns.FacetGrid(trips, col=<span class="string">"usertype"</span>, hue=<span class="string">'usertype'</span>)</div><div class="line">g.map(plt.hist,<span class="string">"elevation_gain"</span>, bins=np.arange(<span class="number">-145</span>, <span class="number">150</span>, <span class="number">10</span>))</div><div class="line">g.fig.set_figheight(<span class="number">6</span>)</div><div class="line">g.fig.set_figwidth(<span class="number">16</span>);</div><div class="line"></div><div class="line"><span class="comment"># plot some lines to guide the eye</span></div><div class="line"><span class="keyword">for</span> lim <span class="keyword">in</span> range(<span class="number">60</span>, <span class="number">150</span>, <span class="number">20</span>):</div><div class="line">    x = np.linspace(-lim, lim, <span class="number">3</span>)</div><div class="line">    <span class="keyword">for</span> ax <span class="keyword">in</span> g.axes.flat:</div><div class="line">        ax.fill(x, <span class="number">100</span> * (lim - abs(x)),</div><div class="line">                color=<span class="string">'gray'</span>, alpha=<span class="number">0.1</span>, zorder=<span class="number">0</span>)</div></pre></td></tr></table></figure>
<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvwev74fzj20su0a2mxj" alt=""></p>
<p>我们在背景中绘制了一些阴影以帮助引导分析。 年度会员和临时用户之间有很大的区别：年费用户非常明显的表示出偏好下坡行程（左侧的分布），而临时用户表现并不明显，而是表示喜欢骑乘开始并在相同高度结束。</p>
<p>为了使海拔数据变化的影响更加明显，我们做一些计算：</p>
<p>In [23]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">print(<span class="string">"total downhill trips:"</span>, (trips.elevation_gain &lt; <span class="number">0</span>).sum())</div><div class="line">print(<span class="string">"total uphill trips:"</span>, (trips.elevation_gain&gt; <span class="number">0</span>).sum())</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">total downhill trips: 80532</div><div class="line">total uphill trips:   50493</div></pre></td></tr></table></figure>
<p>我们看到，第一年下坡比上坡多出了 3 万次 - 这是大约 60％ 以上。 根据目前的使用水平，这意味着 Pronto 工作人员必须每天从海拔较低的服务点运送大约 100 辆自行车到高海拔服务点。</p>
<h2 id="天气"><a href="#天气" class="headerlink" title="天气"></a>天气</h2><p>另一个常见的反对循环共享的可行性的论点是天气。让我们来看看出行数量随着温度和降水量的变化。</p>
<p>幸运的是，数据包括了大范围的天气数据：</p>
<p>In [24]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">weather = pd.read_csv(<span class="string">'2015_weather_data.csv'</span>, index_col=<span class="string">'Date'</span>, parse_dates=<span class="keyword">True</span>)</div><div class="line">weather.columns</div></pre></td></tr></table></figure>
<p>Out[24]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Index([<span class="string">'Max_Temperature_F'</span>, <span class="string">'Mean_Temperature_F'</span>, <span class="string">'Min_TemperatureF'</span>,</div><div class="line">       <span class="string">'Max_Dew_Point_F'</span>, <span class="string">'MeanDew_Point_F'</span>, <span class="string">'Min_Dewpoint_F'</span>, <span class="string">'Max_Humidity'</span>,</div><div class="line">       <span class="string">'Mean_Humidity'</span>, <span class="string">'Min_Humidity'</span>, <span class="string">'Max_Sea_Level_Pressure_In'</span>,</div><div class="line">       <span class="string">'Mean_Sea_Level_Pressure_In'</span>, <span class="string">'Min_Sea_Level_Pressure_In'</span>,</div><div class="line">       <span class="string">'Max_Visibility_Miles'</span>, <span class="string">'Mean_Visibility_Miles'</span>,</div><div class="line">       <span class="string">'Min_Visibility_Miles'</span>, <span class="string">'Max_Wind_Speed_MPH'</span>, <span class="string">'Mean_Wind_Speed_MPH'</span>,</div><div class="line">       <span class="string">'Max_Gust_Speed_MPH'</span>, <span class="string">'Precipitation_In'</span>, <span class="string">'Events'</span>],</div><div class="line">      dtype=<span class="string">'object'</span>)</div><div class="line">       dtype =<span class="string">'object'</span>）</div></pre></td></tr></table></figure>
<p>让我们将天气数据与行程数据结合起来：</p>
<p>In [25]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">by_date = trips.groupby([<span class="string">'date'</span>, <span class="string">'usertype'</span>])[<span class="string">'trip_id'</span>].count()</div><div class="line">by_date.name = <span class="string">'count'</span></div><div class="line">by_date = by_date.reset_index(<span class="string">'usertype'</span>).join(weather)</div></pre></td></tr></table></figure>
<p>现在我们可以看看按工作日和周末为纬度，查看出行数量随温度和降水量的变化：</p>
<p>In [26]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># add a flag indicating weekend</span></div><div class="line">by_date[<span class="string">'weekend'</span>] = (by_date.index.dayofweek&gt;= <span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#----------------------------------------------------------------</span></div><div class="line"><span class="comment"># Plot Temperature Trend</span></div><div class="line">g = sns.FacetGrid(by_date, col=<span class="string">"weekend"</span>, hue=<span class="string">'usertype'</span>, size=<span class="number">6</span>)</div><div class="line">g.map(sns.regplot,<span class="string">"Mean_Temperature_F"</span>,<span class="string">"count"</span>)</div><div class="line">g.add_legend();</div><div class="line"></div><div class="line"><span class="comment"># do some formatting</span></div><div class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].set_title(<span class="string">''</span>)</div><div class="line">g.axes[<span class="number">0</span>, <span class="number">1</span>].set_title(<span class="string">''</span>)</div><div class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].text(<span class="number">0.05</span>, <span class="number">0.95</span>,<span class="string">'Monday - Friday'</span>, va=<span class="string">'top'</span>, size=<span class="number">14</span>,</div><div class="line">                  transform=g.axes[<span class="number">0</span>, <span class="number">0</span>].transAxes)</div><div class="line">g.axes[<span class="number">0</span>, <span class="number">1</span>].text(<span class="number">0.05</span>, <span class="number">0.95</span>,<span class="string">'Saturday - Sunday'</span>, va=<span class="string">'top'</span>, size=<span class="number">14</span>,</div><div class="line">                  transform=g.axes[<span class="number">0</span>, <span class="number">1</span>].transAxes)</div><div class="line">g.fig.text(<span class="number">0.45</span>, <span class="number">1</span>,<span class="string">"Trend With Temperature"</span>, ha=<span class="string">'center'</span>, va=<span class="string">'top'</span>, size=<span class="number">16</span>);</div><div class="line"></div><div class="line"><span class="comment">#----------------------------------------------------------------</span></div><div class="line"><span class="comment"># Plot Precipitation</span></div><div class="line">g = sns.FacetGrid(by_date, col=<span class="string">"weekend"</span>, hue=<span class="string">'usertype'</span>, size=<span class="number">6</span>)</div><div class="line">g.map(sns.regplot,<span class="string">"Precipitation_In "</span>,<span class="string">"count"</span>)</div><div class="line">g.add_legend();</div><div class="line"></div><div class="line"><span class="comment"># do some formatting</span></div><div class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].set_ylim(<span class="number">-50</span>, <span class="number">600</span>);</div><div class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].set_title(<span class="string">''</span>)</div><div class="line">g.axes[<span class="number">0</span>, <span class="number">1</span>].set_title(<span class="string">''</span>)</div><div class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].text(<span class="number">0.95</span>, <span class="number">0.95</span>,<span class="string">'Monday - Friday'</span>, ha=<span class="string">'right'</span>, va=<span class="string">'top'</span>, size=<span class="number">14</span>,</div><div class="line">                  transform=g.axes[<span class="number">0</span>, <span class="number">0</span>].transAxes)</div><div class="line">g.axes[<span class="number">0</span>, <span class="number">1</span>].text(<span class="number">0.95</span>, <span class="number">0.95</span>,<span class="string">'Saturday - Sunday'</span>, ha=<span class="string">'right'</span>, va=<span class="string">'top'</span>, size=<span class="number">14</span>,</div><div class="line">                  transform=g.axes[<span class="number">0</span>, <span class="number">1</span>].transAxes)</div><div class="line">g.fig.text(<span class="number">0.45</span>, <span class="number">1</span>,<span class="string">"Trend With Precipitation"</span>, ha=<span class="string">'center'</span>, va=<span class="string">'top'</span>, size=<span class="number">16</span>);</div></pre></td></tr></table></figure>
<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvwqa1v43j20rp0c4wg6" alt=""><br>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvwqr99vcj20rj0c440e" alt=""></p>
<p>对于天气的影响，我们可以看出明显的趋势：人们更喜欢温暖、阳光明媚的天气。但是也有一些有趣的细节：工作日期间，所有的用户都受到天气的影响。然而周末年费用户受影响更少。我没有什么好的理论说明为什么有这种趋势，如果你有好的想法，欢迎提供。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>根据上面的一些系列分析，但是我想我们可以从这些数据中获得一些结论：</p>
<ul>
<li>年费用户与临时用户整体上会有不同的行为：年费用户通常是利用 Pronto 进行工作日的通勤。临时用户则是周末使用 Pronto 探索城市的特定区域。</li>
<li>尽管年费用户对定价策略有所了解，但是四分之一的行程还是超过了半小时的限制，并产生了额外的费用。为了客户的权益，Pronto 应该更好告知用户这种定价策略。</li>
<li>海拔和天气会影响使用，正如你预计的一样：下坡比上坡多 60%，寒冷和下雨也会明显减少当天的骑行数量。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2017/02/more-effective-golang-error/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/more-effective-golang-error/" itemprop="url">更优雅的 Golang 错误处理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-08T18:00:00+08:00">
                2017-02-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/more-effective-golang-error/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/02/more-effective-golang-error/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Golang 中的错误处理是一个被大家经常拿出来讨论的 <a href="http://www.infoq.com/cn/news/2012/11/go-error-handle" target="_blank" rel="external">话题</a>(另外一个是 <a href="http://www.weibo.com/1609119537/CdzJVejwg?type=comment" target="_blank" rel="external">泛型</a>)。其中泛型这个问题，rsc 在最近的计划中也<a href="https://mp.weixin.qq.com/s?__biz=MjM5OTcxMzE0MQ==&amp;mid=2653369836&amp;idx=1&amp;sn=ddff3df7dbf52bb5bcc8b0ace78e0121&amp;chksm=bce4d5f68b935ce0ece41ada8a49bbd33b638d184901ca8a61b5288daaf7c5a2d63af0cc3b34" target="_blank" rel="external">提出</a> 了纳入他今年的考虑计划中，同时，<a href="https://github.com/golang/proposal/blob/master/design/15292-generics.md" target="_blank" rel="external">泛型的提案</a> 在 2016 年也进行了一些更新，相信未来会有一些更好的方案提出。这个文章我们讨论一下如何在现行的 Golang 框架下提供更友好和优雅的错误处理。</p>
<h2 id="从现状谈起"><a href="#从现状谈起" class="headerlink" title="从现状谈起"></a>从现状谈起</h2><p>Golang 中的错误处理原则，开发者曾经之前专门发布了几篇文章 (<a href="https://blog.golang.org/error-handling-and-go" target="_blank" rel="external">Error handling and Go</a> 和 <a href="https://blog.golang.org/defer-panic-and-recover" target="_blank" rel="external">Defer, Panic, and Recover</a>、<a href="https://blog.golang.org/errors-are-values" target="_blank" rel="external">Errors are values</a> ) 介绍。分别介绍了 Golang 中处理一般预知到的错误与遇到崩溃时的错误处理机制。</p>
<p>一般情况下，我们还是以官方博客中的错误处理例子为例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;f, err := os.Open(<span class="string">"filename.ext"</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;log.Fatal(err)</div><div class="line">        <span class="comment">// 或者更简单的：</span></div><div class="line">        <span class="comment">// return err</span></div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然对于简化代码行数，还有另外一种写法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	...</div><div class="line">    <span class="keyword">if</span> f, err = os.Open(<span class="string">"filename.ext"</span>); err != <span class="literal">nil</span>&#123;log.Fatal(err)</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正常情况下，Golang 现有的哲学中，要求你尽量手工处理所有的错误返回，这稍微增加了开发人员的心智负担。关于这部分设计的讨论，请参考本文最开始提供的参考链接，此处不做太多探讨。</p>
<p>本质上，Golang 中的错误类型 <figure class="highlight plain"><figcaption><span>是一个接口类型：</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>type error interface {Error() string<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">只要满足这一接口定义的所有数值都可以传入 ```error``` 类型的位置。在 [Go Proverbs](http://go-proverbs.github.io/) 中也提到了关于错误的描述： ```Errors are values```。这一句如何理解呢？</div><div class="line"></div><div class="line">Errors are values</div><div class="line">---</div><div class="line"></div><div class="line">事实上，在实际使用过程中，你可能也发现了对 Golang 而言，所有的信息是非常不足的。比如下面这个例子：</div><div class="line"></div><div class="line">```go</div><div class="line">buf := make([]byte, 100)</div><div class="line">n, err := r.Read(buf)</div><div class="line">buf = buf[:n]</div><div class="line">if err == io.EOF &#123;log.Fatal(&quot;read failed:&quot;, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>事实上这只会打印信息 <figure class="highlight plain"><figcaption><span>13:53:54 read failed:EOF```，这对我们真实环境下的错误调试与分析其实是并没有任何意义的，我们在查看日志获取错误信息的时候能够获取到的信息十分有限。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">于是乎，一些提供了上下文方式的一些错误处理形式便在很多类库中非常常见：</div><div class="line"></div><div class="line">```go</div><div class="line">err := os.Remove(&quot;/tmp/nonexist&quot;)</div><div class="line">log.Println(err)</div></pre></td></tr></table></figure></p>
<p>输出了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2017/02/08 14:09:22 remove /tmp/nonexist: no such file or directory</div></pre></td></tr></table></figure>
<p>这种方式提供了一种更加直观的上下文信息，比如具体出错的内容，也可以是出现错误的文件等等。通过查看 Remove 的实现，我们可以看到：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PathError records an error and the operation and file path that caused it.</span></div><div class="line"><span class="keyword">type</span> PathError <span class="keyword">struct</span> &#123;</div><div class="line">	Op   <span class="keyword">string</span></div><div class="line">	Path <span class="keyword">string</span></div><div class="line">	Err  error</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PathError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> e.Op +<span class="string">" "</span>+ e.Path +<span class="string">": "</span>+ e.Err.Error() &#125;</div><div class="line"></div><div class="line"><span class="comment">// file_unix.go 针对 *nix 系统的实现</span></div><div class="line"><span class="comment">// Remove removes the named file or directory.</span></div><div class="line"><span class="comment">// If there is an error, it will be of type *PathError.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Remove</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// System call interface forces us to know</span></div><div class="line">	<span class="comment">// whether name is a file or directory.</span></div><div class="line">	<span class="comment">// Try both: it is cheaper on average than</span></div><div class="line">	<span class="comment">// doing a Stat plus the right one.</span></div><div class="line">	e := syscall.Unlink(name)</div><div class="line">	<span class="keyword">if</span> e == <span class="literal">nil</span> &#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</div><div class="line">	e1 := syscall.Rmdir(name)</div><div class="line">	<span class="keyword">if</span> e1 == <span class="literal">nil</span> &#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Both failed: figure out which error to return.</span></div><div class="line">	<span class="comment">// OS X and Linux differ on whether unlink(dir)</span></div><div class="line">	<span class="comment">// returns EISDIR, so can't use that. However,</span></div><div class="line">	<span class="comment">// both agree that rmdir(file) returns ENOTDIR,</span></div><div class="line">	<span class="comment">// so we can use that to decide which error is real.</span></div><div class="line">	<span class="comment">// Rmdir might also return ENOTDIR if given a bad</span></div><div class="line">	<span class="comment">// file path, like /etc/passwd/foo, but in that case,</span></div><div class="line">	<span class="comment">// both errors will be ENOTDIR, so it's okay to</span></div><div class="line">	<span class="comment">// use the error from unlink.</span></div><div class="line">	<span class="keyword">if</span> e1 != syscall.ENOTDIR &#123;e = e1&#125;</div><div class="line">	<span class="keyword">return</span> &amp;PathError&#123;<span class="string">"remove"</span>, name, e&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际上这里 Golang 标准库中返回了一个名为 <figure class="highlight plain"><figcaption><span>的结构体，这个结构体定义了操作类型、路径和原始的错误信息，然后通过 ```Error``` 方法对所有信息进行了整合。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">但是这样也会存在问题，比如需要进行单独类型复杂的分类处理，比如上面例子中，需要单独处理 ```PathError``` 这种问题，你可能需要一个单独的类型推导：</div><div class="line"></div><div class="line">```go</div><div class="line">err := xxxx()</div><div class="line">if err != nil &#123;swtich err := err.(type) &#123;</div><div class="line">	case *os.PathError:</div><div class="line">		...</div><div class="line">	default:</div><div class="line">		...</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样反倒会增加错误处理的复杂度。同时，这些错误必须变为导出类型，也会增加整个系统的复杂度。</p>
<p>另外一个问题是，我们在出现错误时，我们通常也希望获取更多的堆栈信息，方便我们进行后续的故障追踪。在现有的错误体系中，这相对比较复杂：你很难通过一个接口类型获取完整的调用堆栈。这时，我们可能就需要一个第三方库区去解决遇到的这些错误处理问题。</p>
<p>还有一种情况是，我们希望在错误处理过程中同样可以附加一些信息，这些也会相对比较麻烦。</p>
<h2 id="更优雅的错误处理"><a href="#更优雅的错误处理" class="headerlink" title="更优雅的错误处理"></a>更优雅的错误处理</h2><p>之前提到了多种实际应用场景中出现的错误处理方法和遇到的一些问题，这里推荐使用第三方库去解决部分问题：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">比如当我们出现问题时，我们可以简单的使用 ```errors.New``` 或者 ```errors.Errorf``` 生成一个错误变量：</div><div class="line"></div><div class="line">```go</div><div class="line">err := errors.New(&quot;whoops&quot;)</div><div class="line">// or</div><div class="line">err := errors.Errorf(&quot;whoops: %s&quot;, &quot;foo&quot;)</div></pre></td></tr></table></figure></p>
<p>当我们需要附加信息时，则可以使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cause := errors.New(<span class="string">"whoops"</span>)</div><div class="line">err := errors.Wrap(cause,<span class="string">"oh noes"</span>)</div></pre></td></tr></table></figure>
<p>当需要获取 @用堆栈时，则可以使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">err := errors.New(<span class="string">"whoops"</span>)</div><div class="line">fmt.Printf(<span class="string">"%+v"</span>, err)</div></pre></td></tr></table></figure>
<h2 id="其他建议"><a href="#其他建议" class="headerlink" title="其他建议"></a>其他建议</h2><p>在上面做类型推导时，我们发现在处理一类错误时可能需要多个错误类型，这可能在某些情况下相对来说比较复杂，很多时候我们可以使用接口形式去方便处理：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> temporary <span class="keyword">interface</span> &#123;Temporary() <span class="keyword">bool</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// IsTemporary returns true if err is temporary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsTemporary</span><span class="params">(err error)</span> <span class="title">bool</span></span> &#123;te, ok := errors.Cause(err).(temporary)</div><div class="line">	<span class="keyword">return</span> ok &amp;&amp; te.Temporary()&#125;</div></pre></td></tr></table></figure>
<p>这样就可以提供更加方便的错误解析和处理。</p>
<h3 id="广告时间"><a href="#广告时间" class="headerlink" title="广告时间"></a>广告时间</h3><p>我们正在招收新人 Gopher，应届毕业生 or 实习生欢迎投递简历。我们正在努力实现开发流程标准化，如果你想获得提高，相信也是一个非常不错的机会。简历投递 kevin [at] yeeuu [dot] com。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars0.githubusercontent.com/u/363344?v=3&s=460"
               alt="ipfans" />
          <p class="site-author-name" itemprop="name">ipfans</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">65</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">46</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ipfans" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/janxin" target="_blank" title="Tw1tter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Tw1tter
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.yeeuu.com" title="杭州云柚科技" target="_blank">杭州云柚科技</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ipfans</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://s1mbily.disqus.com/count.js" async></script>
    

    

  




	





  








  





  

  

  

  

  

  

</body>
</html>
