<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="ipfans's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="ipfans&#39;s Blog">
<meta property="og:url" content="https://ipfans.github.io/page/6/index.html">
<meta property="og:site_name" content="ipfans&#39;s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ipfans&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ipfans.github.io/page/6/"/>





  <title>ipfans's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b9862358b198078f40d7e1596b7c5968";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ipfans's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2015/10/write-aio-python-redis-client-as-dummy-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/10/write-aio-python-redis-client-as-dummy-1/" itemprop="url">零基础编写 Python Redis Client（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-10-10T18:11:15+08:00">
                2015-10-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/10/write-aio-python-redis-client-as-dummy-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/10/write-aio-python-redis-client-as-dummy-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是-AIO"><a href="#什么是-AIO" class="headerlink" title="什么是 AIO"></a>什么是 AIO</h2><p>AIO 是 Asynchronous Input/Output 的简写，也就是异步 IO。不过在谈什么是 AIO 之前，我们可能要先介绍一下 BIO。那么什么是 BIO 呢？简单的说，BIO 是 Blocking Input/Output，也就是阻塞 IO，他实现的通常是在线程池中找出一个线程处理 IO，在 IO 过程中，其他线程都需要等待 IO 完成后才可以从中选取一个线程占用 IO。这样最大的问题是，当线程数量较多，并且需要大量的 IO 操作时，就会造成一个大量的阻塞，因为实际上每次只有一个线程在处理 IO。</p>
<p>那么如何解决这个时候的问题呢？这时候就提出了 AIO 的概念。通常在 IO 处理过程中也会伴有一些其他的处理操作，假如把所有的操作都浪费在了等待 IO 释放上，线程池中的线程利用率也太低了，因此我们需要一种方式，在申请 IO 处理之后，就去继续做其他的事情，等 IO 操作完成了，然后通知我们已经 OK，我们可以继续处理了。这也就是我们常说的 AIO 的原型。</p>
<p>AIO 的情况也说明了它适用的场景：长连接场景，或者重度的 IO 操作等等的情况。</p>
<p>如果找软件来做案例，我们可以找一个可能大家熟知的：NGINX。正如我们所知，NGINX 采用了 <a href="http://nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="external">异步、事件驱动的方法来处理连接</a>。这种处理方式无需（像使用传统架构的服务器一样）为每个请求创建额外的专用进程或者线程，而是在一个工作进程中处理多个连接和请求。为此，NGINX 工作在非阻塞的 socket 模式下，并使用了 epoll 和 kqueue 这样有效的方法。</p>
<p>这部分的内容，在 <a href="http://www.infoq.com/cn/articles/thread-pools-boost-performance-9x" target="_blank" rel="external">NGINX 引入线程池 性能提升 9 倍</a> 中进行了详细的介绍，包含了 NGINX 的异步应用经验，同时介绍了 NGINX 中引入了阻塞的线程池用于解决某些特定场景问题下的效率。</p>
<h2 id="如何实现-Python-的异步-IO"><a href="#如何实现-Python-的异步-IO" class="headerlink" title="如何实现 Python 的异步 IO"></a>如何实现 Python 的异步 IO</h2><p>这篇文章会以最新的 Python 3.5 为基础来介绍实现一个异步的 Python Redis Client。不过在此之前，我们先来看一下，怎么实现 Python 的 aio。</p>
<p>Python 的 aio 官方封装了一个比较合适的基础库 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">从一个例子开始简单认识一下如何实现一个异步的 aio client。这里以官方文档中的例子为例：</div><div class="line"></div><div class="line">```python</div><div class="line">import asyncio</div><div class="line"></div><div class="line">async def tcp_echo_client(message, loop):</div><div class="line">    reader, writer = await asyncio.open_connection(&apos;127.0.0.1&apos;, 8888,</div><div class="line">                                                   loop=loop)</div><div class="line"></div><div class="line">    print(&apos;Send: %r&apos; % message)</div><div class="line">    writer.write(message.encode())</div><div class="line"></div><div class="line">    data = await reader.read(100)</div><div class="line">    print(&apos;Received: %r&apos; % data.decode())</div><div class="line"></div><div class="line">    print(&apos;Close the socket&apos;)</div><div class="line">    writer.close()</div><div class="line"></div><div class="line">message = &apos;Hello World!&apos;</div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(tcp_echo_client(message, loop))</div><div class="line">loop.close()</div></pre></td></tr></table></figure></p>
<p>这里面用到的 Python 3.5 中引入的 <figure class="highlight plain"><figcaption><span>关键字，还有 ```asyncio``` 库。这里面 ```asyncio.open_connection``` 会返回一个 coroutine，这个可以使用 await 进行一个 aio 的调用，即，在收到返回信号之前，程序可以继续去处理其他的任务。这里面真正核心的就是 ```EventLoop```，它负责监视发送这些信号，并且返回数据，它可以通过 ```asyncio.get_event_loop``` 获取到。然后他会真正返回的数据是一个读取 ```StreamReader``` 和写入 ```StreamWriter``` 的对象。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">接下来，就可以通过这个 ```reader``` 和 ```writer``` 进行数据的读取和写入。```writer``` 是可以直接写入的，如果是 ```reader``` 的话，就需要 aio 的方式等待受到数据后返回。这样看起来更接近于普通的 socket 编程。不过关闭连接时，仅仅需要关闭 ```writer``` 就足够了。</div><div class="line"></div><div class="line">从 socket 通讯到 redis 通讯</div><div class="line">---</div><div class="line"></div><div class="line">本质上来说，所有的网络请求都可以看成是 SocketIO 的请求，因此，我们可以把 Redis 的请求当做是一个 socket 的通讯来进行，这样就很方便了。</div><div class="line"></div><div class="line">不过先等一等，那么通讯的数据格式怎么办？没关系，这里我们使用 ```hiredis-py``` 来解决协议解析的问题。不过，从库设计的角度来说，我们需要封装一个 RedisConnection 的类出来解决 Redis 的通讯协议。它可能传入的参数包含，一个 ```StreamReader```、一个 ```StreamWriter```，一个 ```EventLoop```，哦，别忘记还有编码 ```encoding```。其他的我们就用一个 ```*``` 来表示好了。</div><div class="line"></div><div class="line">```python</div><div class="line">class RedisConnection(object):</div><div class="line">    &apos;&apos;&apos;Redis Connection&apos;&apos;&apos;</div><div class="line">    def __init__(self, reader, writer, *, encoding=None, loop=None):</div><div class="line">        if loop is None:</div><div class="line">            loop = asyncio.get_event_loop()</div><div class="line">        self._reader = reader</div><div class="line">        self._writer = writer</div><div class="line">        self._encoding = encoding</div><div class="line">        self._loop = loop</div><div class="line">        self._db = 0</div><div class="line"></div><div class="line">    def __repr__(self):</div><div class="line">        return &apos;&lt;RedisConnection [db:&#123;&#125;]&gt;&apos;.format(self._db)</div></pre></td></tr></table></figure></p>
<p>记得加上 <figure class="highlight plain"><figcaption><span>用来描述这个对象，这个可是一个好习惯。接下来就需要完善这个类了，比如，我们需要添加一个关闭连接的方法，这需要至少一个参数用于标记连接是否关闭，一个用于执行关闭操作，比如我们需要这样子的：</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">```python</div><div class="line">    def close(self):</div><div class="line">        &quot;&quot;&quot;Close connection.&quot;&quot;&quot;</div><div class="line">        self._do_close(None)</div><div class="line"></div><div class="line">    def _do_close(self, exc):</div><div class="line">        if self._closed:</div><div class="line">            return</div><div class="line">        self._closed = True</div><div class="line">        self._closing = False</div><div class="line">        # 关闭写入</div><div class="line">        self._writer.transport.close()</div><div class="line">        # 取消读取任务</div><div class="line">        self._reader_task.cancel()</div><div class="line">        self._reader_task = None</div><div class="line">        self._writer = None</div><div class="line">        self._reader = None</div><div class="line"></div><div class="line">    @property</div><div class="line">    def closed(self):</div><div class="line">        &quot;&quot;&quot;True if connection is closed.&quot;&quot;&quot;</div><div class="line">        closed = self._closing or self._closed</div><div class="line">        if not closed and self._reader and self._reader.at_eof():</div><div class="line">            self._closing = closed = True</div><div class="line">            self._loop.call_soon(self._do_close, None)</div><div class="line">        return closed</div></pre></td></tr></table></figure></p>
<p>连接这类的方法已经处理完了，接下来就应该是执行 Redis 命令了，我们可以叫它 <figure class="highlight plain"><figcaption><span>```command```，一个是指令参数 ```*args```，还有一些其他的，比如编码 ```encoding```。这里为了节省时间，只是考虑一些 Set 和 Get 的基本操作。哦，不过等等，那么 Redis 的数据结构是什么样子的呢？我们还需要先把它编译成 Redis-server 可以识别的形式，那么需要一个 ```encode_command``` 方法。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">```python</div><div class="line">_converters = &#123;</div><div class="line">    bytes: lambda val: val,</div><div class="line">    bytearray: lambda val: val,</div><div class="line">    str: lambda val: val.encode(&apos;utf-8&apos;),</div><div class="line">    int: lambda val: str(val).encode(&apos;utf-8&apos;),</div><div class="line">    float: lambda val: str(val).encode(&apos;utf-8&apos;),</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">def encode_command(*args):</div><div class="line">    &quot;&quot;&quot;Encodes arguments into redis bulk-strings array.</div><div class="line">    Raises TypeError if any of args not of bytes, str, int or float type.</div><div class="line">    &quot;&quot;&quot;buf = bytearray()</div><div class="line"></div><div class="line">    def add(data):</div><div class="line">        return buf.extend(data + b&apos;\r\n&apos;)</div><div class="line"></div><div class="line">    add(b&apos;*&apos;+ _bytes_len(args))</div><div class="line">    for arg in args:</div><div class="line">        if type(arg) in _converters:</div><div class="line">            barg = _converters[type(arg)](arg)</div><div class="line">            add(b&apos;$&apos;+ _bytes_len(barg))</div><div class="line">            add(barg)</div><div class="line">        else:</div><div class="line">            raise TypeError(&quot;Argument &#123;!r&#125; expected to be of bytes,&quot;&quot;str, int or float type&quot;.format(arg))</div><div class="line">    return buf</div></pre></td></tr></table></figure></p>
<p>这样可以转化为可以识别的形式了，接下来还有一个问题，那么怎么让程序可以等待信号的生效呢？这里介绍一下 <figure class="highlight plain"><figcaption><span>```asyncio.Future``` 类是用于封装回调函数的类，包含了一些更加方便使用的方法。通过这个类，可以实现 aio 的通知机制，也就是回调。这个类实例可以通过 ```await``` 返回我们需要的结果。不过这样就还需要在项目中添加一些更多的变量，比如所有等待返回的 ```self._waiters```。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">```python</div><div class="line">    def execute(self, command, *args, encoding=None):</div><div class="line">        &quot;&quot;&quot;Executes redis command and returns Future waiting for the answer.</div><div class="line">        Raises:</div><div class="line">        * TypeError if any of args can not be encoded as bytes.</div><div class="line">        * ReplyError on redis &apos;-ERR&apos; resonses.</div><div class="line">        * ProtocolError when response can not be decoded meaning connection</div><div class="line">          is broken.</div><div class="line">        &quot;&quot;&quot;assert self._reader and not self._reader.at_eof(), (&quot;Connection closed or corrupted&quot;)</div><div class="line">        if command is None:</div><div class="line">            raise TypeError(&quot;command must not be None&quot;)</div><div class="line">        if None in set(args):</div><div class="line">            raise TypeError(&quot;args must not contain None&quot;)</div><div class="line">        # 这样小写也没有问题了</div><div class="line">        command = command.upper().strip()</div><div class="line">        if encoding is None:</div><div class="line">            encoding = self._encoding</div><div class="line">        fut = asyncio.Future(loop=self._loop)</div><div class="line">        self._writer.write(encode_command(command, *args))</div><div class="line">        self._waiters.append((fut, encoding, cb))</div><div class="line">        return fut</div></pre></td></tr></table></figure></p>
<p>现在所有的命令都已经发送到了 redis-server，接下来就需要读取对应的结果了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">_read_data</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="string">"""Response reader task."""</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">not</span> self._reader.at_eof():</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            data = <span class="keyword">await</span> self._reader.read(<span class="number">65536</span>)</div><div class="line">        <span class="keyword">except</span> asyncio.CancelledError:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">            <span class="comment"># <span class="doctag">XXX:</span> for QUIT command connection error can be received</span></div><div class="line">            <span class="comment">#       before response</span></div><div class="line">            logger.error(<span class="string">"Exception on data read %r"</span>, exc, exc_info=<span class="keyword">True</span>)</div><div class="line">            <span class="keyword">break</span></div><div class="line">        self._parser.feed(data)</div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                obj = self._parser.gets()</div><div class="line">            <span class="keyword">except</span> ProtocolError <span class="keyword">as</span> exc:</div><div class="line">                <span class="comment"># ProtocolError is fatal</span></div><div class="line">                <span class="comment"># so connection must be closed</span></div><div class="line">                self._closing = <span class="keyword">True</span></div><div class="line">                self._loop.call_soon(self._do_close, exc)</div><div class="line">                <span class="keyword">if</span> self._in_transaction:</div><div class="line">                    self._transaction_error = exc</div><div class="line">                <span class="keyword">return</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">if</span> obj <span class="keyword">is</span> <span class="keyword">False</span>:</div><div class="line">                    <span class="keyword">break</span></div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    self._process_data(obj)</div><div class="line">    self._closing = <span class="keyword">True</span></div><div class="line">    self._loop.call_soon(self._do_close, <span class="keyword">None</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_process_data</span><span class="params">(self, obj)</span>:</span></div><div class="line">    <span class="string">"""Processes command results."""</span></div><div class="line">    waiter, encoding, cb = self._waiters.popleft()</div><div class="line">    <span class="keyword">if</span> waiter.done():</div><div class="line">        logger.debug(<span class="string">"Waiter future is already done %r"</span>, waiter)</div><div class="line">        <span class="keyword">assert</span> waiter.cancelled(), (<span class="string">"waiting future is in wrong state"</span>, waiter, obj)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    <span class="keyword">if</span> isinstance(obj, RedisError):</div><div class="line">        waiter.set_exception(obj)</div><div class="line">        <span class="keyword">if</span> self._in_transaction:</div><div class="line">            self._transaction_error = obj</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">if</span> encoding <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                obj = decode(obj, encoding)</div><div class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">                waiter.set_exception(exc)</div><div class="line">                <span class="keyword">return</span></div><div class="line">        waiter.set_result(obj)</div><div class="line">        <span class="keyword">if</span> cb <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            cb(obj)</div></pre></td></tr></table></figure>
<p>有了这些之后，我们就可以简单创建一个连接了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_connection</span><span class="params">(address, *, db=None, password=None,</span></span></div><div class="line"><span class="function"><span class="params">                      encoding=None, loop=None)</span>:</span></div><div class="line">    <span class="string">"""Creates redis connection.</span></div><div class="line"><span class="string">    Opens connection to Redis server specified by address argument.</span></div><div class="line"><span class="string">    Address argument is similar to socket address argument, ie:</span></div><div class="line"><span class="string">    * when address is a tuple it represents (host, port) pair;</span></div><div class="line"><span class="string">    * when address is a str it represents unix domain socket path.</span></div><div class="line"><span class="string">    (no other address formats supported)</span></div><div class="line"><span class="string">    Encoding argument can be used to decode byte-replies to strings.</span></div><div class="line"><span class="string">    By default no decoding is done.</span></div><div class="line"><span class="string">    Return value is RedisConnection instance.</span></div><div class="line"><span class="string">    This function is a coroutine.</span></div><div class="line"><span class="string">    """</span><span class="keyword">assert</span> isinstance(address, (tuple, list, str)), <span class="string">"tuple or str expected"</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> isinstance(address, (list, tuple)):</div><div class="line">        host, port = address</div><div class="line">        reader, writer = <span class="keyword">await</span> asyncio.open_connection(host, port, loop=loop)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        reader, writer = <span class="keyword">await</span> asyncio.open_unix_connection(address, loop=loop)</div><div class="line">    conn = RedisConnection(reader, writer, encoding=encoding, loop=loop)</div><div class="line"></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">if</span> password <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> conn.auth(password)</div><div class="line">        <span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> conn.select(db)</div><div class="line">    <span class="keyword">except</span> Exception:</div><div class="line">        conn.close()</div><div class="line">    <span class="keyword">return</span> conn</div></pre></td></tr></table></figure>
<p>这样，连接部分的代码基本上已经处理完成了，接下来要做的就是实现基于这个连接的命令执行了，下面的内容会下一个文章中继续介绍，敬请期待。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2015/08/introduction-to-async-and-await/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/08/introduction-to-async-and-await/" itemprop="url">Python async/await 入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-08-14T18:11:15+08:00">
                2015-08-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/08/introduction-to-async-and-await/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/08/introduction-to-async-and-await/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在新版 Python3.5 中，引入了两个新关键字 async 和 await，用于解决在 Python 异步编程中无法有效<br>区分 yield 生成器与异步的关系的问题。</p>
<h2 id="异步是一个什么东西"><a href="#异步是一个什么东西" class="headerlink" title="异步是一个什么东西"></a>异步是一个什么东西</h2><p>异步的作用在于，对于 Python 这种拥有 GIL 的语言，某个线程在处理单个耗时较长的任务时（如 I/O<br>读取，RESTful API 调用）等操作时，不能有效的释放 CPU 资源，导致其他线程的等待时间随之增加。<br>异步的作用是，在等待这种花费大量时间的操作数，允许释放 CPU 资源执行其他的线程任务，从而提<br>高程序的执行效率。</p>
<h2 id="3-4-之前如何实现异步"><a href="#3-4-之前如何实现异步" class="headerlink" title="3.4 之前如何实现异步"></a>3.4 之前如何实现异步</h2><p>在 3.5 版本以前的程序中，Python 程序通常是使用 yield 作为一个判断是否进入异步操作的关键词。<br>比如在 3.4.x 版本中，我们可以用这样的一个例子来看一下 (或者你也可以用一个 Tornado 的例子，这<br>样你的程序就也可以运行在 2.7.x 版本的 Python 中了)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">slow_operation</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1</span>)</div><div class="line">    print(<span class="string">"Slow operation &#123;&#125; complete"</span>.format(n))</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    start = time.time()</div><div class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.wait([slow_operation(<span class="number">1</span>),</div><div class="line">        slow_operation(<span class="number">2</span>),</div><div class="line">        slow_operation(<span class="number">3</span>),</div><div class="line">    ])</div><div class="line">    end = time.time()</div><div class="line">    print(<span class="string">'Complete in &#123;&#125; second(s)'</span>.format(end-start))</div><div class="line"></div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(main())</div></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">➜  Desktop  pyenv shell 3.4.3</div><div class="line">➜  Desktop  python 3.4_asyncio.py</div><div class="line">➜  Desktop  python 3.4_asyncio.py</div><div class="line">Slow operation 2 complete</div><div class="line">Slow operation 1 complete</div><div class="line">Slow operation 3 complete</div><div class="line">Complete in 1.0008249282836914 second(s)</div></pre></td></tr></table></figure>
<p>如果你了解过 yield，你会知道 yield 其实作用是用来生成一个生成器，而生成器的作用是用于输出一系列的结果。比如计算斐波那契数列：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fab</span><span class="params">(max)</span>:</span></div><div class="line">    n, a, b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></div><div class="line">    <span class="keyword">while</span> n &lt; max:</div><div class="line">        <span class="keyword">yield</span> b</div><div class="line">        a, b = b, a + b</div><div class="line">        n = n + <span class="number">1</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> n <span class="keyword">in</span> fab(<span class="number">5</span>):</div><div class="line">    <span class="keyword">print</span> n</div></pre></td></tr></table></figure>
<p>其实这个在实际执行过程中，生成器并未实际执行，只有当调用. next() 时才开始执行，并返回当前的迭代值。最后执行完成之后，则会抛出 StopIteration 异常，表示迭代完成。当然，这个异常在大多数循环情况下 (比如 for) 并不需要手工处理。当然，你也可以选择使用下面手工的方法（注意：next 是 Python3 中的内置函数，如果是 Python2，请使用 f.next()）:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">➜  Desktop  python</div><div class="line">Python 3.4.3 (default, Aug 14 2015, 11:21:11)</div><div class="line">[GCC 4.2.1 Compatible Apple LLVM 6.1.0 (clang-602.0.53)] on darwin</div><div class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</div><div class="line">&gt;&gt;&gt; def fab(max):</div><div class="line">...     n, a, b = 0, 0, 1</div><div class="line">...     while n &lt; max:</div><div class="line">...         yield b</div><div class="line">...         a, b = b, a + b</div><div class="line">...         n = n + 1</div><div class="line">...</div><div class="line">&gt;&gt;&gt; f = fab(5)</div><div class="line">&gt;&gt;&gt; next(f)</div><div class="line">1</div><div class="line">&gt;&gt;&gt; next(f)</div><div class="line">1</div><div class="line">&gt;&gt;&gt; next(f)</div><div class="line">2</div><div class="line">&gt;&gt;&gt; next(f)</div><div class="line">3</div><div class="line">&gt;&gt;&gt; next(f)</div><div class="line">5</div><div class="line">&gt;&gt;&gt; next(f)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</div><div class="line">StopIteration</div></pre></td></tr></table></figure>
<p>上面的方法如果不使用 yield，则换成一个支持 iterable 的可能更直观理解一点：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fab</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, max)</span>:</span></div><div class="line">       self.max = max</div><div class="line">       self.n, self.a, self.b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">       <span class="keyword">return</span> self</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">next</span><span class="params">(self)</span>:</span></div><div class="line">       <span class="keyword">if</span> self.n &lt; self.max:</div><div class="line">           r = self.b</div><div class="line">           self.a, self.b = self.b, self.a + self.b</div><div class="line">           self.n = self.n + <span class="number">1</span></div><div class="line">           <span class="keyword">return</span> r</div><div class="line">       <span class="keyword">raise</span> StopIteration()</div></pre></td></tr></table></figure>
<p>在异步中，程序的 ioloop 会自动处理这一类的生成器，这一个样例可以参考一下 Tornado 的处理方式: <a href="http://www.tornadoweb.org/en/stable/_modules/tornado/gen.html#coroutine" target="_blank" rel="external">tornado.gen.coroutine</a>。</p>
<h2 id="3-5-版本异步功能"><a href="#3-5-版本异步功能" class="headerlink" title="3.5 版本异步功能"></a>3.5 版本异步功能</h2><p>在 3.5 之后的版本里，程序提供了 async 和 await 关键字，这两个关键字可以替代类似 tornado 中的 gen.coroutine/yield 或者是 asyncio.coroutine/yield 的作用。</p>
<p>比如在上一节中的例子改造成为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line">import time</div><div class="line"></div><div class="line">async def slow_operation(n):</div><div class="line">    await asyncio.sleep(1)</div><div class="line">    print(&quot;Slow operation &#123;&#125; complete&quot;.format(n))</div><div class="line"></div><div class="line"></div><div class="line">async def main():</div><div class="line">    start = time.time()</div><div class="line">    await asyncio.wait([slow_operation(1),</div><div class="line">        slow_operation(2),</div><div class="line">        slow_operation(3),</div><div class="line">    ])</div><div class="line">    end = time.time()</div><div class="line">    print(&apos;Complete in &#123;&#125; second(s)&apos;.format(end-start))</div><div class="line"></div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(main())</div></pre></td></tr></table></figure>
<p>新的关键字会让我们的程序看上去更加清晰。不过从执行效率上看，现在还是相较 3.4.3 有一些退步：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">➜  Desktop  pyenv shell 3.5.0rc1</div><div class="line">➜  Desktop  python 3.5_asyncio.py</div><div class="line">Slow operation 1 complete</div><div class="line">Slow operation 3 complete</div><div class="line">Slow operation 2 complete</div><div class="line">Complete in 1.0012218952178955 second(s)</div><div class="line">➜  Desktop  python 3.4_asyncio.py</div><div class="line">Slow operation 1 complete</div><div class="line">Slow operation 3 complete</div><div class="line">Slow operation 2 complete</div><div class="line">Complete in 1.0060911178588867 second(s)</div></pre></td></tr></table></figure>
<p>不过现在还只是 RC 版本，相信之后还是会有一些性能调优的可能性。</p>
<h2 id="更多的开发场景"><a href="#更多的开发场景" class="headerlink" title="更多的开发场景"></a>更多的开发场景</h2><p>现在 Tornado 正在开发的 4.3 版本已经支持了 Python3.5 的 async/await 关键字，在之后的开发中，可以替代 @gen.coroutine 和 yield 用于开发。根据作者的描述，如果是运行在 3.5 版本的 Python 上，建议使用关键字而不是 yield 方式，这样可以有更好的执行效率。当然，如果 3.5 只是一个可选版本，相信在相当长的一段时间之内，你还是需要使用原有的执行方式。</p>
<h2 id="潜在的坑"><a href="#潜在的坑" class="headerlink" title="潜在的坑"></a>潜在的坑</h2><p>async 和 await 在 Python 3.5 与 3.6 版本中并不是关键字，Python 3.7 中会作为关键字。因此需要在现有的程序中替代掉已有的可能导致冲突的关键字。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2015/08/jwt-basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/08/jwt-basic/" itemprop="url">JWT 介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-08-07T18:11:15+08:00">
                2015-08-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/08/jwt-basic/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/08/jwt-basic/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="JWT-是什么"><a href="#JWT-是什么" class="headerlink" title="JWT 是什么"></a>JWT 是什么</h2><p>JWT 全称是 JSON Web Tokens，是 RFC 7519 标准，用于安全校验两方可信性的安全措施。</p>
<h2 id="JWT-解决了哪些问题？"><a href="#JWT-解决了哪些问题？" class="headerlink" title="JWT 解决了哪些问题？"></a>JWT 解决了哪些问题？</h2><p>JWT 本身设计是用于解决 Session 机制不能够很好的在 SPA/API 类型 (restful) 应用中处理身份认证问题。通常 API 的调用是无状态（stateless）的，使用 Session 等形式会有上下文要求。如当用户登录完成后，可以通过下发 JWT 的形式进行无状态的 API 调用。在此之前通常是使用的方式包括不限于如 Basic Auth、Oauth2 或 Token 形式进行。</p>
<p>JWT 相比是额外添加了签名校验方式，本质上来说对抗如暴力碰撞等形式有一些作用。但是由于本身长度的限制，存储的信息量有限。</p>
<h2 id="JWT-处理方式"><a href="#JWT-处理方式" class="headerlink" title="JWT 处理方式"></a>JWT 处理方式</h2><p>JWT 内容主要分为三段，分别对应头部信息，存储数据和签名信息三部分，中间使用『.』符号连接，三段信息均进行 Base64 编码。</p>
<p>具体实现方式可参考如下伪代码实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">encodeBase64(header) + &apos;.&apos; + encodeBase64(payload) + &apos;.&apos; + Sign(key + encodeBase64(header) + &apos;.&apos; + encodeBase64(payload))</div></pre></td></tr></table></figure>
<p>其中 Sign 的算法是可以在 header 中进行定义，支持如 HMAC-SHA256 和 RSA-SHA256 等方式。key 则是用于验证的 key 信息。</p>
<p>其中 header 格式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;alg&quot;: &quot;HS256&quot;, // 指定加密算法，可以选择 RS256 等。</div><div class="line">  &quot;typ&quot;: &quot;JWT&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>payload 为存储的数据区块，由于此部分未进行加密，不建议存储敏感信息。内容为字典结构。</p>
<h2 id="JWT-存在的安全问题"><a href="#JWT-存在的安全问题" class="headerlink" title="JWT 存在的安全问题"></a>JWT 存在的安全问题</h2><p>JWT 披露了一个比较 <a href="https://auth0.com/blog/2015/03/31/critical-vulnerabilities-in-json-web-token-libraries/" target="_blank" rel="external">严重的安全问题</a>：JWT 中允许设置加密方法『alg』为 none，这样签名信息可设置为 “”，这样就给恶意用户伪造 JWT 的可能。并且该验证是在验证签名之前（决定签名使用算法），所以在安全实现 JWT 时需要对验证算法进行可信安全校验。</p>
<p>还有一个问题是 JWT 本身并不会加密 payload 中的信息，因此在传递敏感信息时需要单独对数据进行个别处理。</p>
<h2 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h2><ol>
<li>JWT.io <a href="http://jwt.io/" target="_blank" rel="external">http://jwt.io/</a></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2015/07/howto-make-your-own-permission-plugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/howto-make-your-own-permission-plugin/" itemprop="url">如何用 Python 实现一个权限管理系列 (一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-07-22T11:00:15+08:00">
                2015-07-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/07/howto-make-your-own-permission-plugin/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/07/howto-make-your-own-permission-plugin/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在实现大型 B2B 系统之后，有很多细节需要考虑，其中一环就是权限控制。之前考虑的比较少，认为这一块框架可以 handle 问题不大，后来发现 Tornado 目前没有一个比较完善的权限管理模块，甚至连个包都没有… 于是只能自己动手，丰衣足食了。参考的方式也是通过 Flask-Principal 的类似实现方式。</p>
<h2 id="原型"><a href="#原型" class="headerlink" title="原型"></a>原型</h2><p>一个权限管理模块应该有的功能应该有哪些呢？从基本角度出发，应该包含用户身份 (Identity)、用户角色（RoleNeed）、用户权限（Permission）这三个最基本的分类组成。那么从最开始，就需要定义这几个类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoleNeed</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Identity</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Permission</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<p>再考虑一下，其实 RoleNeed 更像一个权限的枚举数组，除此之外，比如用户可能存在的权限与分组和单独的用户权限都有关系，这里需要更加抽象一下。具体的可以分成 UserNeed 和 RoleNeed，分别对应用户权限与用户组权限。这样如果通过类实现还是比较麻烦，需要继承，但是实际上这也只是一个元组而已。所以可以选择下面的方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial。</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</div><div class="line"></div><div class="line">Need = namedtuple(<span class="string">'Need'</span>, [<span class="string">'method'</span>, <span class="string">'value'</span>])</div><div class="line"></div><div class="line">UserNeed = partial(Need,<span class="string">'user'</span>)</div><div class="line">RoleNeed = partial(Need,<span class="string">'role'</span>)</div></pre></td></tr></table></figure>
<p>namedtuple 是 Python 高级数据结构中的一个内容，在 collections 包中，其实实现的效果是生成带名称的元组。比如 Need = namedtuple(‘Need’, [‘method’, ‘value’]) 实际上就是生成了一个名字叫做 Need 的元组，你可以通过 Need(‘a’, ‘b’) 的方式设置对应的 method 和 value 的值。</p>
<p>接下来的 partial 是和之前我另一篇文章中介绍的 wraps 在一个包中的功能，可以简单理解为方便填入一个初始化参数的方法，比如 partial(Need,’user’) 等同于 Need(‘user’, x)，但是 x 的这个参数需要在调用 parial 的返回值的时候才会传入，可以用来预定义一部分的环境参数。</p>
<p>现在相当于我们定义了一个以用户为维度身份权限要求和以用户组为维度的身份要求。接下来就可以实现用户身份的一些功能了。</p>
<p>用户身份或者权限保存我们应该交由上层的业务逻辑来实现，以保证最大的模块复用性，那么用户身份就剩下了，声明用户身份和判断用户是否有权限执行某项权限操作的内容。</p>
<p>所以我们可以这样实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class Identity(object):</div><div class="line">    &quot;&quot;&quot;</div><div class="line">    A set of needs provided by this user</div><div class="line"></div><div class="line">    example:</div><div class="line">        identity = Identity(&apos;ali&apos;)</div><div class="line">        identity.provides.add((&apos;role&apos;, &apos;admin&apos;))</div><div class="line">    &quot;&quot;&quot;def __init__(self, name):</div><div class="line">        self.name = name</div><div class="line">        self.provides = set()</div><div class="line"></div><div class="line">    def can(self, permission):</div><div class="line">        return permission.allows(self)</div></pre></td></tr></table></figure>
<p>这里的 provides 是作为用户权限的声明，是一个每个权限的集合。可以在最开始登录等等时间进行加载。而 can 方法则是判断某个权限是否可以被执行。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://ipfans.github.io/2015/06/something-about-python-decorator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/something-about-python-decorator/" itemprop="url">Python Decorator 修饰器简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-06-17T18:00:15+08:00">
                2015-06-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/06/something-about-python-decorator/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/06/something-about-python-decorator/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>很久没有写技术存档了，太过于罪恶。最近在智能硬件创业公司担任架构师，推广一些更新更酷的技术应用在各个方面，包括 Golang/Python/Docker 等，如果你有兴趣，也欢迎加入我们: kevin[at yeeuu[dot]com。广告时间结束。</p>
<p>Python 的修饰器是比较常见的开发应用帮助工具，他可以实现一些批量的修饰工作，比如统一来添加一些小功能等等。但是这些功能对原有的函数不产生侵入，也就是说可以实现快速的修改和替换、移除。</p>
<p>如果你使用过 Python 的 Web 框架，相信你对修饰器应该并不陌生：<a href="https://docs.djangoproject.com/en/1.8/topics/http/decorators/" target="_blank" rel="external">Django</a>、<a href="http://flask.pocoo.org/docs/0.10/patterns/viewdecorators/" target="_blank" rel="external">Flask</a>、<a href="http://tornado.readthedocs.org/en/latest/gen.html#decorators" target="_blank" rel="external">Tornado</a> 等常见的框架中都包含了修饰器的使用。</p>
<p>那么 decorators 是怎么实现的呢？还是先从一个简单的例子开始。先看下 Tornado 中的 <a href="">tornado.web.authenticated</a> 使用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line"><span class="meta">    @tornado.web.authenticated</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        self.render(<span class="string">'index.html'</span>)</div></pre></td></tr></table></figure>
<p>tornado.web.authenticated 的作用就是判断 self.current_user 是否为 None 或者为空，否则跳转到之前设置的 login_url 地址去。至于获取 current_user 的内容，可以通过重载 get_current_user 函数实现。</p>
<p>在查看修饰器的具体代码之前，我们先来了解一下 Python 修饰器的原理。Python 的修饰器其实是实现了下面的一个简单功能：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@decorator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">func = decorator(func)</div></pre></td></tr></table></figure>
<p>多层的修饰器则是实现了多层的回调调用。同时在底层层面，提供了 <a href="https://docs.python.org/2/library/functools.html" target="_blank" rel="external">functools 包</a> 用于实现相关功能，注意，该包是 2.5 之后版本中引入，如果你还在使用古老的 Python 版本，则可以手工实现同等功能。</p>
<p>具体功能 <a href="http://tornado.readthedocs.org/en/latest/_modules/tornado/web.html#authenticated" target="_blank" rel="external">实现代码</a> 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">authenticated</span><span class="params">(method)</span>:</span></div><div class="line">    <span class="string">"""Decorate methods with this to require that the user be logged in.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">    If the user is not logged in, they will be redirected to the configured</span></div><div class="line"><span class="string">    `login url &lt;RequestHandler.get_login_url&gt;`.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">    If you configure a login url with a query parameter, Tornado will</span></div><div class="line"><span class="string">    assume you know what you're doing and use it as-is.  If not, it</span></div><div class="line"><span class="string">    will add a `next` parameter so the login page knows where to send</span></div><div class="line"><span class="string">    you once you're logged in."""</span></div><div class="line">    <span class="comment"># method 作为参数传入，实际上为类中的 get 等函数。</span></div><div class="line"><span class="meta">    @functools.wraps(method)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        <span class="comment"># 判断当前用户</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.current_user:</div><div class="line">            <span class="comment"># 没有权限操作</span></div><div class="line">            <span class="keyword">if</span> self.request.method <span class="keyword">in</span> (<span class="string">"GET"</span>, <span class="string">"HEAD"</span>):</div><div class="line">                <span class="comment"># get、head 请求跳转到登录页面</span></div><div class="line">                url = self.get_login_url()</div><div class="line">                <span class="keyword">if</span> <span class="string">"?"</span> <span class="keyword">not</span> <span class="keyword">in</span> url:</div><div class="line">                    <span class="keyword">if</span> urlparse.urlsplit(url).scheme:</div><div class="line">                        <span class="comment"># if login url is absolute, make next absolute too</span></div><div class="line">                        next_url = self.request.full_url()</div><div class="line">                    <span class="keyword">else</span>:</div><div class="line">                        next_url = self.request.uri</div><div class="line">                    url += <span class="string">"?"</span> + urlencode(dict(next=next_url))</div><div class="line">                self.redirect(url)</div><div class="line">                <span class="keyword">return</span></div><div class="line">            <span class="comment"># 403 无权限操作</span></div><div class="line">            <span class="keyword">raise</span> HTTPError(<span class="number">403</span>)</div><div class="line">        <span class="comment"># 通过验证</span></div><div class="line">        <span class="keyword">return</span> method(self, *args, **kwargs)</div><div class="line">    <span class="comment"># 函数式编程的典型范例 :)</span></div><div class="line">    <span class="keyword">return</span> wrapper</div></pre></td></tr></table></figure>
<p>根据这个，我们也可以尝试写一个自己的修饰器:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> functools</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_hello</span><span class="params">(method)</span>:</span></div><div class="line"><span class="meta">    @functools.wraps(method)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"hello!"</span></div><div class="line">        <span class="keyword">return</span> method(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@print_hello</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'in main'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  Desktop  python test_decorator.py</div><div class="line">hello!</div><div class="line">in main</div></pre></td></tr></table></figure>
<p>现在看起来已经很不错了，但是不能修改参数看起来有些需求还是无法实现。那么能够通过修饰器传递修改一些参数么？答案是肯定的。</p>
<p>修改一下上面的例子，我们试着用修饰器向函数中传递参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> functools</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_hello</span><span class="params">(method)</span>:</span></div><div class="line"><span class="meta">    @functools.wraps(method)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        kwargs[<span class="string">'name'</span>] = <span class="string">'Pythonic'</span></div><div class="line">        <span class="keyword">return</span> method(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@print_hello</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(name)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Hello, &#123;&#125;"</span>.format(name)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<p>输出结果为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">➜  Desktop  python test_decorator.py</div><div class="line">Hello, Pythonic</div></pre></td></tr></table></figure>
<p>那么能不能向修饰器里面传递参数呢？当然也是可以的，不过相对来说更复杂一点：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> functools</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_hello</span><span class="params">(name)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">real_wrapper</span><span class="params">(method)</span>:</span></div><div class="line"><span class="meta">        @functools.wraps(method)</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            kwargs[<span class="string">'name'</span>] = name</div><div class="line">            <span class="keyword">return</span> method(*args, **kwargs)</div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line">    <span class="keyword">return</span> real_wrapper</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@print_hello(name='Pythonic')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(name)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Hello, &#123;&#125;"</span>.format(name)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<p>输出结果为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">➜  Desktop  python test_decorator.py</div><div class="line">Hello, Pythonic</div></pre></td></tr></table></figure>
<p>上面的实现方法是函数式的实现，Python 同样支持类模式的修饰器支持，比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">function_wrapper</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, wrapped)</span>:</span></div><div class="line">        self.wrapped = wrapped</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.wrapped(*args, **kwargs)</div><div class="line"></div><div class="line"><span class="meta">@function_wrapper</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">function</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<p>虽然修饰器很好，但是也是会存在一些问题的，使用这种方式之后，想要获取被包装函数的参数（argument）或源代码（source code）时并不能取到正确的结果。不过这个问题可以通过使用反射来解决：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_true_argspec</span><span class="params">(method)</span>:</span></div><div class="line">    argspec = inspect.getargspec(method)</div><div class="line">    args = argspec[<span class="number">0</span>]</div><div class="line">    <span class="keyword">if</span> args <span class="keyword">and</span> args[<span class="number">0</span>] == <span class="string">'self'</span>:</div><div class="line">        <span class="keyword">return</span> argspec</div><div class="line">    <span class="keyword">if</span> hasattr(method,<span class="string">'__func__'</span>):</div><div class="line">        method = method.__func__</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(method,<span class="string">'func_closure'</span>) <span class="keyword">or</span> method.func_closure <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> Exception(<span class="string">"No closure for method."</span>)</div><div class="line"></div><div class="line">    method = method.func_closure[<span class="number">0</span>].cell_contents</div><div class="line">    <span class="keyword">return</span> get_true_argspec(method)</div></pre></td></tr></table></figure>
<p>不过说实话，很少在项目中获取这些东西，只是提供一些解决方案，实际上 functools.wraps 可以解决绝大多数的问题。</p>
<p>最后介绍一些比较常用的修饰器使用方法，比如，进行性能测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> cProfile, pstats, StringIO</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_profile</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        datafn = func.__name__ + <span class="string">".profile"</span> <span class="comment"># Name the data file</span></div><div class="line">        prof = cProfile.Profile()</div><div class="line">        retval = prof.runcall(func, *args, **kwargs)</div><div class="line">        s = StringIO.StringIO()</div><div class="line">        sortby = <span class="string">'cumulative'</span></div><div class="line">        ps = pstats.Stats(prof, stream=s).sort_stats(sortby)</div><div class="line">        ps.print_stats()</div><div class="line">        <span class="keyword">print</span> s.getvalue()</div><div class="line">        <span class="keyword">return</span> retval</div><div class="line"></div><div class="line">    <span class="keyword">return</span> wrapper</div></pre></td></tr></table></figure>
<p>还有一些案例可以看之前提供的几个框架的 API，比如路由组织，异步处理等等都是通过修饰器实现的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars0.githubusercontent.com/u/363344?v=3&s=460"
               alt="ipfans" />
          <p class="site-author-name" itemprop="name">ipfans</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">65</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">46</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ipfans" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/janxin" target="_blank" title="Tw1tter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Tw1tter
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.yeeuu.com" title="杭州云柚科技" target="_blank">杭州云柚科技</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ipfans</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://s1mbily.disqus.com/count.js" async></script>
    

    

  




	





  








  





  

  

  

  

  

  

</body>
</html>
